<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiến Lên Miền Nam 4 Người</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body {margin:0;background:#0d4f1a;color:#fff;font-family:Arial,Helvetica,sans-serif;overflow:hidden;}
  #joinForm {text-align:center;padding-top:20vh;}
  input {padding:12px 20px;width:240px;margin:10px;border-radius:12px;border:none;font-size:18px;}
  button {padding:14px 40px;margin:10px;background:#ffeb3b;color:#000;border:none;border-radius:12px;font-weight:bold;font-size:20px;cursor:pointer;}
  #gameArea {display:none;width:100vw;height:100vh;position:relative;}
  .table {
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:720px;height:480px;background:#1a7f3a;border-radius:50%;box-shadow:0 10px 40px rgba(0,0,0,0.8);
  }
  .hand {position:absolute;display:flex;gap:7px;justify-content:center;align-items:center;}
  #hand0 {bottom:15px;left:50%;transform:translateX(-50%);}
  #hand1 {top:15px;right:30px;flex-direction:column;}
  #hand2 {top:15px;left:50%;transform:translateX(-50%);}
  #hand3 {top:15px;left:15px;left:30px;flex-direction:column;}
  .card {
    width:56px;height:78px;background:#fff;color:#000;border:3px solid #333;border-radius:10px;
    display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;
    cursor:pointer;box-shadow:0 5px 15px rgba(0,0,0,0.6);transition:0.25s;
  }
  .card.he {color:red;}
  .card.selected {transform:translateY(-30px);box-shadow:0 20px 35px gold !important;}
  .card.back {background:#000;color:#000;}
  #playedArea {
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:360px;height:200px;display:flex;flex-wrap:wrap;gap:12px;justify-content:center;align-items:center;
  }
  .played-card {
    width:70px;height:96px;background:#fff;color:#000;border-radius:10px;
    display:flex;align-items:center;justify-content:center;font-size:28px;font-weight:bold;
    box-shadow:0 8px 20px rgba(0,0,0,0.7);transform:rotate(var(--r));
  }
  .played-card.he {color:red;}
  .name {position:absolute;font-weight:bold;font-size:18px;pointer-events:none;}
  #name0 {bottom:100px;left:50%;transform:translateX(-50%);}
  #name1 {top:90px;right:40px;}
  #name2 {top:40px;left:50%;transform:translateX(-50%);}
  #name3 {top:90px;left:40px;}
  #status {position:absolute;top:15px;left:50%;transform:translateX(-50%);font-size:22px;font-weight:bold;}
  #readyBtn {
    position:absolute;bottom:80px;left:50%;transform:translateX(-50%);
    padding:16px 60px;background:#e91e63;color:#fff;font-size:24px;border:none;border-radius:16px;
    box-shadow:0 6px 20px rgba(0,0,0,0.5);
  }
  #readyBtn.ready {background:#4caf50;}
  .controls {
    position:absolute;bottom:15px;left:50%;transform:translateX(-50%);
  }
  .controls button {
    padding:14px 45px;margin:0 15px;background:#ffeb3b;color:#000;font-weight:bold;border-radius:12px;
  }
  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}
</style>
</head>
<body>

<div id="joinForm">
  <h1 style="color:#ffeb3b;font-size:52px;text-shadow:0 0 20px gold;margin-bottom:30px">TIẾN LÊN MIỀN NAM</h1>
  <input id="roomId" value="123" placeholder="ID phòng"><br>
  <input id="playerName" placeholder="Tên của bạn"><br><br>
  <button onclick="joinRoom()">THAM GIA PHÒNG</button>
</div>

<div id="gameArea">
  <div id="status">Phòng 123 • 0/4 người</div>
  <div class="table">
    <div id="name2" class="name"></div>
    <div id="hand2" class="hand"></div>
    <div id="name1" class="name"></div>
    <div id="hand1" class="hand"></div>
    <div id="playedArea"><div style="color:#ccc;font-size:36px">Bàn bài trống</div></div>
    <div id="name3" class="name"></div>
    <div id="hand3" class="hand"></div>
    <div id="name0" class="name">Bạn</div>
    <div id="hand0" class="hand"></div>
  </div>

  <button id="readyBtn" style="display:none">SẴN SÀNG</button>

  <div class="controls">
    <button id="playBtn" onclick="playSelected()" disabled>ĐÁNH</button>
    <button id="skipBtn" onclick="skipTurn()" disabled>BỎ QUA</button>
  </div>
</div>

<script>
let hand=[],selected=[],myIndex=-1,currentTurn=-1,roomId='123',players=[],readyList=[],gameStarted=false;
let cardsLeft=[0,0,0,0];

const socket=io();

function joinRoom(){
  roomId=document.getElementById('roomId').value.trim()||'123';
  const name=document.getElementById('playerName').value.trim()||'Người chơi';
  socket.emit('joinRoom',{roomId,playerName:name});
}

socket.on('youJoined',d=>{
  myIndex=d.myIndex;
  document.getElementById('joinForm').style.display='none';
  document.getElementById('gameArea').style.display='block';
  document.getElementById('readyBtn').style.display='block';
});

socket.on('roomUpdate',d=>{
  players=d.names||[]; readyList=d.ready||[];
  document.getElementById('status').innerHTML=`Phòng ${roomId} • ${d.count}/4 người`;
  updateNames();
  updateReadyButton();
  renderHands(); // luôn render để tên hiện đúng
});

socket.on('gameStarted',d=>{
  gameStarted=true;
  hand=d.hand||[];
  currentTurn=d.currentTurn;
  selected=[];
  document.getElementById('readyBtn').style.display='none';
  document.getElementById('playedArea').innerHTML='<div style="color:#ccc;font-size:36px">Bàn bài trống</div>';
  renderHands();
  updateTurn();
});

socket.on('updateCardsLeft',d=>{cardsLeft=d.cardsLeft;renderHands();});

socket.on('cardsPlayed',d=>{
  const area=document.getElementById('playedArea');area.innerHTML='';
  d.cards.forEach(c=>{
    const el=document.createElement('div');
    el.className='played-card'+(['♥','♦'].includes(c.slice(-1))?' he':'');
    el.style.setProperty('--r',(Math.random()*50-25)+'deg');
    el.innerText=c;
    area.appendChild(el);
  });
  if(d.playerIndex===myIndex){hand=hand.filter(x=>!d.cards.includes(x));selected=[];renderHands();}
  updateTurn();
});

socket.on('turnChanged',d=>{currentTurn=d.currentTurn;updateTurn();});
socket.on('turnSkipped',()=>{updateTurn();});
socket.on('newRound',()=>{document.getElementById('playedArea').innerHTML='<div style="color:gold;font-size:48px">VÒNG MỚI!</div>';});
socket.on('gameOver',d=>{
  document.getElementById('playedArea').innerHTML=`<div style="color:#ffeb3b;font-size:56px">CHÚC MỪNG ${d.winner} THẮNG!</div>`;
  setTimeout(()=>location.reload(),8000);
});

function toggleReady(){socket.emit('toggleReady',roomId);}

function updateReadyButton(){
  const btn=document.getElementById('readyBtn');
  if(gameStarted){btn.style.display='none';return;}
  btn.style.display='block';
  const ready=readyList.includes(myIndex);
  btn.innerText=ready?'HỦY SẴN SÀNG':'SẴN SÀNG';
  btn.className=ready?'ready':'';
}

function renderHands(){
  // Tay mình
  document.getElementById('hand0').innerHTML=hand.map(c=>{
    const red=['♥','♦'].includes(c.slice(-1))?'he':'';
    return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
  }).join('');

  // 3 người khác – chỉ hiện lá khi gameStarted
  for(let i=1;i<=3;i++){
    const idx=(myIndex+i)%4;
    const count=gameStarted?cardsLeft[idx]:0;
    document.getElementById(`hand${i}`).innerHTML=Array(count).fill('<div class="card back">?</div>').join('');
  }
}

function updateNames(){
  for(let i=0;i<4;i++){
    const el=document.getElementById(`name${i}`);
    el.innerText=i===myIndex?'Bạn':(players[i]||'Đang chờ...');
    if(readyList.includes(i)) el.innerText+=' Ready';
    el.style.color=i===currentTurn?'#ff1744':'#ffca28';
  }
}

function toggle(c){
  selected=selected.includes(c)?selected.filter(x=>x!==c):[...selected,c];
  renderHands();
  document.getElementById('playBtn').disabled=selected.length===0||myIndex!==currentTurn;
}
function playSelected(){
  if(selected.length&&myIndex===currentTurn){
    socket.emit('playCards',{roomId,cards:selected});
    selected=[];renderHands();
  }
}
function skipTurn(){
  if(myIndex===currentTurn) socket.emit('skipTurn',roomId);
}
function updateTurn(){
  const myTurn=myIndex===currentTurn;
  document.getElementById('playBtn').disabled=!myTurn||selected.length===0;
  document.getElementById('skipBtn').disabled=!myTurn;
  document.getElementById('status').innerHTML=myTurn
    ?'<span style="color:#ff1744;animation:blink 1s infinite;font-size:48px">ĐẾN LƯỢT BẠN!</span>'
    :`Đợi <strong>${players[currentTurn]||'???'}</strong> đánh...`;
}
</script>
</body>
</html>
