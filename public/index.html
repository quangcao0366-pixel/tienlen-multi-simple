<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiến Lên Miền Nam - Multiplayer</title>
  <style>
    body { margin:0; font-family: Arial; background: #0b6623; color: white; text-align: center; padding: 20px; }
    h1 { margin: 10px; }
    input, button { padding: 12px; margin: 5px; font-size: 16px; }
    button { background: #ffca28; border: none; border-radius: 8px; cursor: pointer; }
    #gameArea { max-width: 1000px; margin: 0 auto; }
    #table { background: #1b5e20; padding: 30px; border-radius: 20px; min-height: 120px; margin: 20px 0; font-size: 40px; }
    #hand { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin: 20px 0; }
    .card { 
      background: white; color: black; padding: 15px 10px; border-radius: 10px; 
      cursor: pointer; font-weight: bold; user-select: none; transition: all 0.2s;
      width: 60px; font-size: 20px;
    }
    .card.selected { background: #ffd700; transform: translateY(-20px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
    .card.he { color: red; }
    .card.bich, .card.tep { color: black; }
    #controls { margin: 20px; }
    #controls button { padding: 15px 30px; font-size: 20px; margin: 0 10px; }
  </style>
</head>
<body>
  <h1>Tiến Lên Miền Nam Multiplayer</h1>
  <div id="joinForm">
    <input id="roomId" placeholder="ID phòng (vd: 123)" value="123" />
    <input id="playerName" placeholder="Tên bạn" />
    <button onclick="joinRoom()">Vào Phòng</button>
  </div>

  <div id="gameArea" style="display:none">
    <div id="status">Đang chờ 4 người...</div>
    <div id="players"></div>
    <div id="table">Bàn bài trống</div>
    <div id="controls">
      <button onclick="playSelected()" id="playBtn" disabled>Đánh Bài</button>
      <button onclick="skipTurn()" id="skipBtn" disabled>Bỏ Lượt</button>
    </div>
    <div id="hand"></div>
  </div>

  <audio id="soundPlay" src="https://cdn.jsdelivr.net/gh/vietnam-game/sound@tienlen/card.mp3"></audio>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123';

    function joinRoom() {
      roomId = document.getElementById('roomId').value || '123';
      const name = document.getElementById('playerName').value || 'Người chơi';
      socket.emit('joinRoom', { roomId, playerName: name });
      document.getElementById('joinForm').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
    }

    socket.on('joinedRoom', data => myIndex = data.playerIndex);
    socket.on('roomUpdate', data => document.getElementById('status').innerText = `Đang có ${data.count}/4 người`);

    socket.on('gameStarted', data => {
      hand = data.hand; myIndex = data.myIndex; currentTurn = data.currentTurn;
      document.getElementById('players').innerHTML = data.players.map((n,i) => `<p>${i===currentTurn?'→':''} ${n}</p>`).join('');
      renderHand();
      updateTurn();
    });

    socket.on('cardsPlayed', data => {
      document.getElementById('table').innerHTML = data.cards.map(c => `<span style="margin:10px;font-size:50px">${c}</span>`).join('');
      document.getElementById('status').innerText = `${data.playerName} vừa đánh! → Lượt ${data.nextTurn + 1}`;
      new Audio('/soundPlay').play();
      updateTurn();
    });

    socket.on('turnSkipped', data => {
      currentTurn = data.nextTurn;
      updateTurn();
    });

    socket.on('newRound', () => {
      document.getElementById('table').innerHTML = 'Vòng mới!';
    });

    socket.on('gameOver', data => {
      alert(`CHÚC MỪNG ${data.winner} THẮNG CỤC!`);
    });

    function renderHand() {
      const div = document.getElementById('hand');
      div.innerHTML = hand.map(card => {
        const suit = card.slice(-1);
        const color = (suit === '♥' || suit === '♦') ? 'he' : 'bich';
        return `<div class="card ${color} ${selected.includes(card)?'selected':''}" onclick="toggle('${card}')">${card}</div>`;
      }).join('');
    }

    function toggle(card) {
      if (selected.includes(card)) selected = selected.filter(c => c !== card);
      else selected.push(card);
      renderHand();
      document.getElementById('playBtn').disabled = selected.length === 0;
    }

    function playSelected() {
      if (selected.length === 0) return;
      socket.emit('playCards', { roomId, cards: selected });
      selected = [];
      renderHand();
      document.getElementById('playBtn').disabled = true;
    }

    function skipTurn() {
      socket.emit('skipTurn', { roomId });
    }

    function updateTurn() {
      const isMy = myIndex === currentTurn;
      document.getElementById('skipBtn').disabled = !isMy;
      document.getElementById('playBtn').disabled = !isMy || selected.length === 0;
      document.getElementById('status').innerHTML = isMy ? '<strong>ĐẾN LƯỢT BẠN!</strong>' : `Đợi người chơi ${currentTurn + 1}...`;
    }
  </script>
</body>
</html>
