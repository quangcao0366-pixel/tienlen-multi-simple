<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiến Lên Miền Nam Multiplayer</title>
<style>
  * {box-sizing:border-box;}
  body {margin:0; font-family:Arial; background:#0b6623; color:white; height:100vh; display:flex; flex-direction:column; overflow:hidden;}
  h1 {margin:10px auto; color:#ffca28; text-shadow:0 0 15px gold; font-size:26px; text-align:center;}

  #joinForm {text-align:center; padding:20px;}
  input, button {padding:12px 20px; margin:5px; font-size:18px; border-radius:10px;}
  button {background:#ffca28; border:none; font-weight:bold; cursor:pointer;}

  #gameArea {flex:1; display:flex; flex-direction:column; position:relative; padding:10px 20px;}

  /* Bàn bài đẹp, vừa vặn, cân đối */
  #table {
    width: 680px; height: 420px;
    background: radial-gradient(circle at center, #1b5e20 20%, #0b6623 100%);
    border: 14px solid #8B4513;
    border-radius: 50%;
    margin: 20px auto;
    position: relative;
    box-shadow: inset 0 0 60px rgba(0,0,0,0.8), 0 0 40px #ffca28;
  }
  #playedArea {
    position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    display:flex; flex-wrap:wrap; gap:15px; justify-content:center; align-items:center;
    width: 520px; min-height:150px; padding:20px;
  }
  .played-card {
    font-size: 56px; background:white; color:black; padding:10px 14px; border-radius:12px;
    box-shadow:0 10px 25px rgba(0,0,0,0.7);
    animation: flyIn 0.6s ease-out forwards;
    transform: rotate(var(--r, 0deg));
  }
  @keyframes flyIn {from{transform:translateY(500px) scale(0.2); opacity:0} to{opacity:1}}

  /* Vị trí 4 người chơi - chuẩn bàn thật */
  .seat {
    position: absolute; text-align:center; font-weight:bold; color:#ffca28; font-size:20px;
  }
  #seat0 {bottom: 10px; left:50%; transform:translateX(-50%);} /* Bạn */
  #seat1 {top: 15px; left: 50px;}
  #seat2 {top: 15px; right: 50px;}
  #seat3 {bottom: 10px; right: 50px;}

  .hand-container {
    display:flex; justify-content:center; gap:9px; flex-wrap:wrap; margin-top:8px;
    max-width: 680px;
  }
  .card {
    background:white; color:black; padding:15px 8px; border-radius:10px; cursor:pointer;
    font-weight:bold; user-select:none; transition:all .2s; width:66px; font-size:21px;
    box-shadow:0 5px 12px rgba(0,0,0,0.6);
  }
  .card.selected {background:#ffd700; transform:translateY(-30px); box-shadow:0 20px 40px gold;}
  .card.he {color:red;}
  .card.back {background:#222 !important; color:#666; cursor:default; box-shadow:0 4px 8px #000;}

  #controls {text-align:center; margin:15px 0;}
  #controls button {padding:18px 50px; font-size:24px; margin:0 20px; border-radius:12px;}
  #status {font-size:30px; font-weight:bold; text-align:center; margin:10px; color:#ffca28;}
  @keyframes blink {0%,100%{opacity:1} 50%{opacity:0.3}}
</style>
</head>
<body>
<h1>Tiến Lên Miền Nam Multiplayer</h1>

<div id="joinForm">
  <input id="roomId" placeholder="ID phòng (vd: 123)" value="123">
  <input id="playerName" placeholder="Tên của bạn">
  <button onclick="joinRoom()">VÀO PHÒNG</button>
</div>

<div id="gameArea" style="display:none">
  <div id="status">Đang chờ đủ 4 người...</div>

  <!-- Bàn bài -->
  <div id="table">
    <div id="playedArea"><div style="color:#cccccc; font-size:28px;">Bàn bài trống</div></div>
  </div>

  <!-- 4 ghế chơi -->
  <div class="seat" id="seat1"><div id="name1"></div><div class="hand-container" id="hand1"></div></div>
  <div class="seat" id="seat2"><div id="name2"></div><div class="hand-container" id="hand2"></div></div>
  <div class="seat" id="seat3"><div id="name3"></div><div class="hand-container" id="hand3"></div></div>
  <div class="seat" id="seat0"><div id="name0">Bạn</div><div class="hand-container" id="hand0"></div></div>

  <div id="controls">
    <button id="playBtn" disabled>ĐÁNH BÀI</button>
    <button id="skipBtn" disabled>BỎ LƯỢT</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [];
const socket = io();

function joinRoom() {
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Người chơi';
  socket.emit('joinRoom', { roomId, playerName: name });
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'flex';
}

socket.on('youJoined', d => myIndex = d.myIndex);
socket.on('roomUpdate', d => {
  players = d.names || [];
  document.getElementById('status').innerHTML = `<strong>Phòng ${roomId}</strong> • ${d.count}/4 người`;
});

socket.on('gameStarted', d => {
  hand = d.hand; myIndex = d.myIndex; currentTurn = d.currentTurn; players = d.players; selected = [];
  document.getElementById('playedArea').innerHTML = '<div style="color:#cccccc; font-size:28px;">Bàn bài trống</div>';
  renderAllHands();
  updateTurn();
});

socket.on('cardsPlayed', d => {
  const area = document.getElementById('playedArea');
  area.innerHTML = '';
  d.cards.forEach((c, i) => {
    const el = document.createElement('div');
    el.className = 'played-card';
    el.style.setProperty('--r', (Math.random()*40 - 20) + 'deg');
    el.innerText = c;
    if (['♥','♦'].includes(c.slice(-1))) el.style.color = 'red';
    area.appendChild(el);
  });
  hand = hand.filter(c => !d.cards.includes(c));
  selected = [];
  renderAllHands();
  updateTurn();
});

socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); renderAllHands(); });
socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); renderAllHands(); });
socket.on('newRound', () => {
  document.getElementById('playedArea').innerHTML = '<div style="color:gold; font-size:36px; text-shadow:0 0 10px red;">VÒNG MỚI – AI CŨNG ĐÁNH ĐƯỢC!</div>';
});
socket.on('gameOver', d => {
  setTimeout(() => alert(`CHÚC MỪNG ${d.winner} ĂN CỤC TRẮNG!`), 800);
});

function renderAllHands() {
  for (let i = 0; i < 4; i++) {
    const handDiv = document.getElementById('hand' + i);
    const nameDiv = document.getElementById('name' + (i === 0 ? '0' : i));
    nameDiv.innerText = i === myIndex ? 'Bạn' : (players[i] || 'Đang chờ...');
    nameDiv.style.color = i === currentTurn ? '#ff1744' : '#ffca28';

    if (i === myIndex) {
      handDiv.innerHTML = hand.map(c => {
        const red = ['♥','♦'].includes(c.slice(-1)) ? 'he' : '';
        return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
      }).join('');
    } else {
      const remaining = 13 - (i === currentTurn && selected.length > 0 ? selected.length : 0);
      handDiv.innerHTML = Array(remaining).fill().map(() => 
        '<div class="card back">?</div>'
      ).join('');
    }
  }
}

function toggle(c) {
  if (selected.includes(c)) selected = selected.filter(x => x !== c);
  else selected.push(c);
  renderAllHands();
  document.getElementById('playBtn').disabled = selected.length === 0 || myIndex !== currentTurn;
}

function playSelected() {
  if (selected.length === 0 || myIndex !== currentTurn) return;
  socket.emit('playCards', { roomId, cards: selected });
}

function skipTurn() {
  if (myIndex !== currentTurn) return;
  socket.emit('skipTurn', { roomId });
}

function updateTurn() {
  const myTurn = myIndex === currentTurn;
  document.getElementById('playBtn').disabled = !myTurn || selected.length === 0;
  document.getElementById('skipBtn').disabled = !myTurn;
  document.getElementById('status').innerHTML = myTurn
    ? '<span style="color:#ff1744; font-size:34px; animation:blink 1s infinite;">ĐẾN LƯỢT BẠN – ĐÁNH ĐI NGAY!</span>'
    : `Đợi <strong>${players[currentTurn] || 'người chơi'}</strong> đánh...`;
}
</script>
</body>
</html>
