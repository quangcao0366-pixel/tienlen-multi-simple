<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiến Lên Miền Nam Multiplayer</title>
<style>
  body {margin:0; font-family:Arial; background:#0b6623; color:white; height:100vh; display:flex; flex-direction:column;}
  h1 {margin:15px; color:#ffca28; text-shadow:0 0 15px gold; font-size:28px;}
  input, button {padding:12px; margin:5px; font-size:16px; border-radius:8px;}
  button {background:#ffca28; border:none; cursor:pointer; font-weight:bold;}

  #gameArea {flex:1; display:flex; flex-direction:column; justify-content:space-between; max-width:1100px; margin:0 auto; padding:10px;}

  /* Bàn bài nhỏ gọn, đẹp, cân đối */
  #table {
    background: radial-gradient(#1b5e20 30%, #0b6623 100%);
    border: 12px solid #8B4513;
    border-radius: 50%;
    width: 650px; height: 400px;
    margin: 0 auto;
    position: relative;
    box-shadow: inset 0 0 50px rgba(0,0,0,0.7), 0 0 30px #ffca28;
  }
  #playedArea {
    position: absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    display:flex; flex-wrap:wrap; gap:12px; justify-content:center; width:500px;
  }
  .played-card {
    font-size: 52px; padding:8px 12px; background:white; color:black; border-radius:10px;
    box-shadow:0 8px 20px rgba(0,0,0,0.7); 
    animation: flyIn 0.5s ease-out;
    transform: rotate(var(--r));
  }
  @keyframes flyIn {from{transform:translateY(400px) scale(0); opacity:0} to{opacity:1}}

  /* Hiển thị bài của 4 người xung quanh bàn */
  .player-area {
    position: absolute; text-align:center; font-weight:bold; color:#ffca28;
  }
  #p0 {bottom: -80px; left: 50%; transform: translateX(-50%);} /* Bạn */
  #p1 {top: 10px; left: 10px;}
  #p2 {top: 10px; right: 10px;}
  #p3 {bottom: -80px; right: 10px; transform: translateX(50%);}

  .hand-container {
    display:flex; justify-content:center; gap:8px; flex-wrap:wrap; max-width:700px; margin:10px auto;
  }
  .card {
    background:white; color:black; padding:14px 8px; border-radius:10px; cursor:pointer;
    font-weight:bold; user-select:none; transition:all .2s; width:62px; font-size:20px;
    box-shadow:0 5px 10px rgba(0,0,0,0.5);
  }
  .card.selected {background:#ffd700; transform:translateY(-25px); box-shadow:0 15px 30px gold;}
  .card.he {color:red;}

  #controls {text-align:center; margin:15px 0;}
  #controls button {padding:16px 40px; font-size:22px; margin:0 15px;}
  #status {font-size:28px; font-weight:bold; text-align:center; margin:10px; color:#ffca28;}
  @keyframes blink {0%,100%{opacity:1} 50%{opacity:0.3}}
</style>
</head>
<body>
<h1>Tiến Lên Miền Nam Multiplayer</h1>

<div id="joinForm">
  <input id="roomId" placeholder="ID phòng (vd: 123)" value="123">
  <input id="playerName" placeholder="Tên của bạn">
  <button onclick="joinRoom()">VÀO PHÒNG</button>
</div>

<div id="gameArea" style="display:none">
  <div id="status">Đang chờ đủ 4 người...</div>
  <div id="players"></div>

  <!-- Bàn bài + bài đã đánh -->
  <div id="table">
    <div id="playedArea"><div style="color:#aaa;font-size:24px">Bàn bài trống</div></div>
  </div>

  <!-- Hiển thị tên + bài của 4 người -->
  <div class="player-area" id="p1"><div id="name1"></div><div class="hand-container" id="hand1"></div></div>
  <div class="player-area" id="p2"><div id="name2"></div><div class="hand-container" id="hand2"></div></div>
  <div class="player-area" id="p3"><div id="name3"></div><div class="hand-container" id="hand3"></div></div>
  <div class="player-area" id="p0"><div id="name0">Bạn</div><div class="hand-container" id="hand0"></div></div>

  <div id="controls">
    <button id="playBtn" disabled>ĐÁNH BÀI</button>
    <button id="skipBtn" disabled>BỎ LƯỢT</button>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [];
const socket = io();

function joinRoom() {
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Người chơi';
  socket.emit('joinRoom', { roomId, playerName: name });
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'flex';
  document.getElementById('gameArea').style.flexDirection = 'column';
}

socket.on('youJoined', d => myIndex = d.myIndex);
socket.on('roomUpdate', d => {
  players = d.names || [];
  document.getElementById('status').innerText = `Phòng ${roomId} • ${d.count}/4 người`;
});

socket.on('gameStarted', d => {
  hand = d.hand; myIndex = d.myIndex; currentTurn = d.currentTurn; players = d.players; selected = [];
  document.getElementById('playedArea').innerHTML = '<div style="color:#aaa;font-size:24px">Bàn bài trống</div>';
  renderAllHands();
  updateTurn();
});

socket.on('cardsPlayed', d => {
  const area = document.getElementById('playedArea');
  area.innerHTML = '';
  d.cards.forEach((c,i) => {
    const el = document.createElement('div');
    el.className = 'played-card';
    el.style.setProperty('--r', (Math.random()*30-15)+'deg');
    el.innerText = c;
    if (['♥','♦'].includes(c.slice(-1))) el.style.color = 'red';
    area.appendChild(el);
  });
  renderAllHands();
  updateTurn();
});

socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); });
socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); });
socket.on('newRound', () => document.getElementById('playedArea').innerHTML = '<div style="color:gold;font-size:32px">VÒNG MỚI!</div>');
socket.on('gameOver', d => setTimeout(() => alert(`${d.winner} THẮNG CỤC! Ván mới sau 5s...`), 600));

function renderAllHands() {
  for (let i = 0; i < 4; i++) {
    const container = document.getElementById('hand'+i);
    const nameEl = document.getElementById('name'+(i===0?'0':i===1?1:i===2?2:3));
    nameEl.innerText = i === myIndex ? 'Bạn' : players[i] || 'Đang chờ...';
    nameEl.style.color = i === currentTurn ? '#ff1744' : '#ffca28';

    if (i === myIndex) {
      container.innerHTML = hand.map(c => {
        const red = ['♥','♦'].includes(c.slice(-1))?'he':'';
        return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
      }).join('');
    } else {
      const count = (players.length > i && hand.length === 13) ? (13 - (selected.length > 0 && myIndex === i ? selected.length : 0)) : 13;
      container.innerHTML = Array(count).fill().map(() => '<div class="card" style="background:#333; color:#666; cursor:default">?</div>').join('');
    }
  }
}

function toggle(c) {
  if (selected.includes(c)) selected = selected.filter(x=>x!==c);
  else selected.push(c);
  renderAllHands();
  document.getElementById('playBtn').disabled = selected.length===0 || myIndex !== currentTurn;
}

function playSelected() {
  if (selected.length===0 || myIndex !== currentTurn) return;
  socket.emit('playCards', { roomId, cards: selected });
  selected = [];
}

function skipTurn() {
  if (myIndex !== currentTurn) return;
  socket.emit('skipTurn', { roomId });
}

function updateTurn() {
  const myTurn = myIndex === currentTurn;
  document.getElementById('playBtn').disabled = !myTurn || selected.length===0;
  document.getElementById('skipBtn').disabled = !myTurn;
  document.getElementById('status').innerHTML = myTurn 
    ? '<span style="color:#ff1744; animation:blink 1s infinite; font-size:32px">ĐẾN LƯỢT BẠN – ĐÁNH ĐI!</span>'
    : `Đợi <strong>${players[currentTurn]}</strong> đánh...`;
  renderAllHands();
}
</script>
</body>
</html>
