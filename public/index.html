<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CHÍ DŨNG CLUB - Tiến Lên Miền Nam</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  body{
    margin:0;background:#051408;color:#fff;font-family:'Segoe UI',sans-serif;overflow:hidden;height:100vh;
    background: radial-gradient(circle at center, #0a3d1a, #000);
  }
  .logo{
    position:fixed;top:15px;left:20px;font-size:36px;font-weight:900;color:#ffd700;
    text-shadow: 0 0 10px #ff0, 0 0 20px #ff0, 0 0 40px #ff0, 0 0 80px #ff0;
    animation: neon 1.5s ease-in-out infinite alternate;z-index:9999;
  }
  @keyframes neon{from{text-shadow:0 0 10px #ff0,0 0 20px #ff0,0 0 40px #ff0,0 0 80px #ff0}to{text-shadow:0 0 20px #ff0,0 0 30px #ff0,0 0 50px #ff0,0 0 100px #ff0}}

  #joinForm{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;
  }
  #joinForm h1{
    font-size:68px;color:#ffd700;text-shadow:0 0 30px gold;margin:0 0 40px 0;
  }
  input{
    padding:18px 30px;width:300px;margin:15px;border-radius:20px;border:none;font-size:22px;
    box-shadow:0 8px 25px rgba(0,0,0,0.6);background:#fff;color:#000;
  }
  button{
    padding:20px 80px;background:#ffd700;color:#000;border:none;border-radius:50px;
    font-weight:900;font-size:28px;cursor:pointer;margin-top:20px;
    box-shadow:0 10px 30px rgba(0,0,0,0.7);transition:.3s;
  }
  button:hover{transform:scale(1.05);box-shadow:0 15px 40px gold}

  #gameArea{display:none;width:100vw;height:100vh;position:relative;
    background: radial-gradient(ellipse at center, #1a5f38 0%, #051408 100%);
  }
  .table{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:820px;height:580px;background:radial-gradient(#1e7b3a,#0a3d1a);
    border-radius:50%;box-shadow:0 0 100px rgba(0,255,0,0.5),inset 0 0 80px #000;
    border:10px solid #ffd700;
  }
  .hand{position:absolute;display:flex;justify-content:center;align-items:center}
  #hand0{bottom:20px;left:50%;transform:translateX(-50%);gap:6px;padding:0 30px;max-width:96vw;overflow-x:auto;scrollbar-width:none}
  #hand0::-webkit-scrollbar{display:none}
  #hand1{top:25px;right:45px;flex-direction:column;gap:5px}
  #hand2{top:25px;left:50%;transform:translateX(-50%);gap:6px}
  #hand3{top:25px;left:45px;flex-direction:column;gap:5px}

  .card{
    width:68px;height:98px;background:#fff;color:#000;border-radius:12px;
    border:3px solid #000;box-shadow:0 8px 25px rgba(0,0,0,0.9);
    position:relative;cursor:pointer;transition:all .3s;font-weight:bold;
    display:flex;flex-direction:column;align-items:center;justify-content:space-between;
    padding:8px 4px;font-size:16px;
  }
  .card.he{color:red}
  .card.selected{transform:translateY(-50px) scale(1.1);box-shadow:0 35px 60px gold;z-index:99}
  .card .rank{font-size:28px}
  .card .suit{font-size:38px}
  .card .logo{
    position:absolute;bottom:5px;right:5px;font-size:9px;color:#ffd700;
    font-weight:900;text-shadow:1px 1px 3px #000;
  }
  .card.back{
    background:#0a3d1a;border:4px solid #ffd700;
    background-image: repeating-linear-gradient(45deg, #0a3d1a 0, #0f4d20 10px, #0a3d1a 20px);
  }

  #playedArea{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:440px;height:280px;display:flex;flex-wrap:wrap;gap:20px;justify-content:center;align-items:center}
  .played-card{width:86px;height:120px;background:#fff;color:#000;border-radius:14px;box-shadow:0 15px 40px rgba(0,0,0,0.9);transform:rotate(var(--r));display:flex;flex-direction:column;align-items:center;justify-content:center;font-size:38px;font-weight:bold}
  .played-card.he{color:red}
  .played-card .rank{font-size:44px}
  .played-card .suit{font-size:52px;margin-top:-10px}

  .name{position:absolute;font-weight:900;font-size:21px;text-shadow:0 0 15px gold}
  #name0{bottom:120px;left:50%;transform:translateX(-50%)}
  #name1{top:110px;right:55px}#name2{top:55px;left:50%;transform:translateX(-50%)}
  #name3{top:110px;left:55px}

  #status{position:absolute;top:25px;left:50%;transform:translateX(-50%);font-size:28px;font-weight:bold;text-shadow:0 0 15px #fff}
  #readyBtn{
    position:absolute;bottom:100px;left:50%;transform:translateX(-50%);
    padding:22px 100px;background:#d50000;color:#fff;font-size:32px;border:none;border-radius:50px;
    box-shadow:0 12px 35px rgba(0,0,0,0.8);font-weight:900;transition:.3s;
  }
  #readyBtn.ready{background:#00c853}
  #readyBtn:hover{transform:translateX(-50%) scale(1.05)}

  .controls{position:absolute;bottom:25px;left:50%;transform:translateX(-50%)}
  .controls button{padding:20px 70px;margin:0 30px;background:#ffd700;color:#000;font-weight:900;border-radius:16px;font-size:24px}

  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}
</style>
</head>
<body>

<div class="logo">CHÍ DŨNG CLUB</div>

<div id="joinForm">
  <h1>CHÍ DŨNG CLUB</h1>
  <input id="roomId" value="123" placeholder="ID phòng"><br>
  <input id="playerName" placeholder="Tên anh em"><br><br>
  <button onclick="joinRoom()">VÀO PHÒNG NGAY</button>
</div>

<div id="gameArea">
  <div id="status">Phòng 123 • 0/4 anh em</div>
  <div class="table">
    <div id="name2" class="name"></div><div id="hand2" class="hand"></div>
    <div id="name1" class="name"></div><div id="hand1" class="hand"></div>
    <div id="playedArea"><div style="color:#ccc;font-size:44px">Bàn bài trống</div></div>
    <div id="name3" class="name"></div><div id="hand3" class="hand"></div>
    <div id="name0" class="name">Bạn</div><div id="hand0" class="hand"></div>
  </div>
  <button id="readyBtn" onclick="toggleReady()">SẴN SÀNG</button>
  <div class="controls">
    <button id="playBtn" onclick="playSelected()" disabled>ĐÁNH</button>
    <button id="skipBtn" onclick="skipTurn()" disabled>BỎ QUA</button>
  </div>
</div>

<script>
let hand=[],selected=[],myIndex=-1,currentTurn=-1,roomId='123',players=[],readyList=[],gameStarted=false,cardsLeft=[0,0,0,0];
const socket=io();

const suitSymbol = {S:'spade', H:'heart', D:'diamond', C:'club'};

function getCardHTML(c){
  const rank = c.slice(0,-1)==='10'?'10':c.slice(0,-1);
  const suit = c.slice(-1);
  const isRed = ['H','D'].includes(suit);
  return `<div class="card ${isRed?'he':''} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">
    <div class="rank">${rank}</div>
    <div class="suit">${suitSymbol[suit]}</div>
    <div class="logo">CHÍ DŨNG</div>
  </div>`;
}

function joinRoom(){
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Anh Em';
  socket.emit('joinRoom', {roomId, playerName: name});
}

socket.on('youJoined', d => {
  myIndex = d.myIndex;
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('readyBtn').style.display = 'block';
});

socket.on('roomUpdate', d => {
  players = d.names || []; readyList = d.ready || [];
  document.getElementById('status').innerHTML = `Phòng ${roomId} • ${d.count}/4 anh em`;
  updateNames(); updateReadyButton(); renderHands();
});

socket.on('gameStarted', d => {
  gameStarted = true; hand = d.hand || []; currentTurn = d.currentTurn; selected = [];
  document.getElementById('readyBtn').style.display = 'none';
  document.getElementById('playedArea').innerHTML = '<div style="color:#ccc;font-size:44px">Bàn bài trống</div>';
  renderHands(); updateTurn();
});

socket.on('updateCardsLeft', d => {cardsLeft = d.cardsLeft; renderHands();});
socket.on('cardsPlayed', d => {
  const area = document.getElementById('playedArea'); area.innerHTML = '';
  d.cards.forEach(c => {
    const el = document.createElement('div');
    el.className = 'played-card' + (c.includes('heart')||c.includes('diamond')?' he':'');
    el.style.setProperty('--r', (Math.random()*40-20)+'deg');
    const rank = c.slice(0,-1)==='10'?'10':c.slice(0,-1);
    const suit = c.slice(-1);
    el.innerHTML = `<div class="rank">${rank}</div><div class="suit">${suitSymbol[suit]}</div>`;
    area.appendChild(el);
  });
  if(d.playerIndex===myIndex){hand=hand.filter(x=>!d.cards.includes(x));selected=[];renderHands();}
  updateTurn();
});
socket.on('turnChanged', d => {currentTurn = d.currentTurn; updateTurn();});
socket.on('newRound', () => {document.getElementById('playedArea').innerHTML='<div style="color:gold;font-size:60px">VÒNG MỚI!</div>';});
socket.on('gameOver', d => {document.getElementById('playedArea').innerHTML=`<div style="color:#ffd700;font-size:68px">CHÚC MỪNG ${d.winner} THẮNG!</div>`;setTimeout(()=>location.reload(),8000);});

function toggleReady(){socket.emit('toggleReady',{roomId});}
function updateReadyButton(){
  const btn = document.getElementById('readyBtn');
  if(gameStarted){btn.style.display='none';return;}
  const ready = readyList.includes(myIndex);
  btn.innerText = ready ? 'HỦY SẴN SÀNG' : 'SẴN SÀNG';
  btn.className = ready ? 'ready' : '';
}
function renderHands(){
  document.getElementById('hand0').innerHTML = hand.map(getCardHTML).join('');
  for(let i=1;i<=3;i++){
    const idx = (myIndex + i) % 4;
    const cnt = gameStarted ? cardsLeft[idx] : 0;
    document.getElementById(`hand${i}`).innerHTML = Array(cnt).fill('<div class="card back"></div>').join('');
  }
}
function updateNames(){
  for(let i=0;i<4;i++){
    const el = document.getElementById(`name${i}`);
    el.innerText = i===myIndex?'Bạn':(players[i]||'Đang chờ...');
    if(readyList.includes(i)) el.innerText += ' Ready';
    el.style.color = i===currentTurn?'#ff1744':'#ffd700';
  }
}
function toggle(c){
  selected = selected.includes(c) ? selected.filter(x=>x!==c) : [...selected,c];
  renderHands();
}
function playSelected(){
  if(selected.length && myIndex===currentTurn){
    socket.emit('playCards',{roomId,cards:selected});
    selected=[];
  }
}
function skipTurn(){
  if(myIndex===currentTurn) socket.emit('skipTurn',{roomId});
}
function updateTurn(){
  const myTurn = myIndex===currentTurn;
  document.getElementById('playBtn').disabled = !myTurn || selected.length===0;
  document.getElementById('skipBtn').disabled = !myTurn;
  document.getElementById('status').innerHTML = myTurn
    ? '<span style="color:#ff1744;animation:blink 1s infinite;font-size:56px">ĐẾN LƯỢT BẠN!</span>'
    : `Đợi <strong>${players[currentTurn]||'???'}</strong> đánh...`;
}
</script>
</body>
</html>
