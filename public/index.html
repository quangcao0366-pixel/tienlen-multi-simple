<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiến Lên Miền Nam Multiplayer</title>
<style>
  body {margin:0; font-family:Arial; background:#0b6623; color:white; text-align:center; padding:20px; overflow:hidden;}
  h1 {margin:10px; color:#ffca28; text-shadow:0 0 10px gold;}
  input, button {padding:12px; margin:5px; font-size:16px; border-radius:8px;}
  button {background:#ffca28; border:none; cursor:pointer; font-weight:bold;}
  #gameArea {max-width:1200px; margin:0 auto; position:relative;}
  
  /* BÀN BÀI ĐẸP NHƯ THẬT */
  #table {
    background: radial-gradient(circle at center, #1b5e20 0%, #0b6623 100%);
    border: 15px solid #8B4513;
    border-radius: 50%;
    width: 800px; height: 500px;
    margin: 30px auto;
    position: relative;
    box-shadow: inset 0 0 60px rgba(0,0,0,0.8), 0 0 40px gold;
    display: flex; align-items: center; justify-content: center;
    overflow: hidden;
  }
  #playedArea {
    position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
    display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; width: 600px;
  }
  .played-card {
    font-size: 60px; padding: 10px; background: white; color: black; border-radius: 12px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.7); transform: rotate(var(--r, 0deg)) scale(1);
    animation: flyIn 0.6s ease-out;
  }
  @keyframes flyIn { from {transform: translateY(300px) scale(0.3); opacity:0;} to {opacity:1;} }

  #hand {display:flex; flex-wrap:wrap; justify-content:center; gap:12px; margin:30px 0;}
  .card {
    background:white; color:black; padding:18px 10px; border-radius:12px; cursor:pointer;
    font-weight:bold; user-select:none; transition:all .2s; width:70px; font-size:22px;
    box-shadow:0 6px 12px rgba(0,0,0,0.5);
  }
  .card.selected {background:#ffd700; transform:translateY(-30px); box-shadow:0 20px 40px gold;}
  .card.he {color:red;}
  #controls button {padding:18px 40px; font-size:24px; margin:20px;}
  #status {font-size:32px; font-weight:bold; margin:20px; color:#ffca28;}
  @keyframes blink {0%,100%{opacity:1} 50%{opacity:0.3}}
</style>
</head>
<body>
<h1>Tiến Lên Miền Nam Multiplayer</h1>

<div id="joinForm">
  <input id="roomId" placeholder="ID phòng (vd: 123)" value="123">
  <input id="playerName" placeholder="Tên của bạn">
  <button onclick="joinRoom()">VÀO PHÒNG</button>
</div>

<div id="gameArea" style="display:none">
  <div id="status">Đang chờ 4 người...</div>
  <div id="players"></div>
  
  <!-- BÀN BÀI ĐẸP LUNG LINH -->
  <div id="table">
    <div id="playedArea">Bàn bài trống</div>
  </div>
  
  <div id="controls">
    <button id="playBtn" disabled>ĐÁNH BÀI</button>
    <button id="skipBtn" disabled>BỎ LƯỢT</button>
  </div>
  <div id="hand"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [];
const socket = io();

function joinRoom() {
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Người chơi';
  socket.emit('joinRoom', { roomId, playerName: name });
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
}

socket.on('youJoined', d => myIndex = d.myIndex);
socket.on('roomUpdate', d => {
  players = d.names || [];
  document.getElementById('status').innerText = `Đang có ${d.count}/4 người`;
});

socket.on('gameStarted', d => {
  hand = d.hand; myIndex = d.myIndex; currentTurn = d.currentTurn; players = d.players;
  selected = [];
  document.getElementById('playedArea').innerHTML = 'Bàn bài trống';
  renderHand();
  updateTurn();
  updatePlayersList();
});

socket.on('cardsPlayed', d => {
  const area = document.getElementById('playedArea');
  area.innerHTML = '';
  d.cards.forEach((card, i) => {
    const el = document.createElement('div');
    el.className = 'played-card';
    el.style.setProperty('--r', (Math.random()*40 - 20) + 'deg');
    el.innerText = card;
    if (['♥','♦'].includes(card.slice(-1))) el.style.color = 'red';
    area.appendChild(el);
  });
  updateTurn(); updatePlayersList();
});

socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); updatePlayersList(); });
socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); updatePlayersList(); });
socket.on('newRound', () => { document.getElementById('playedArea').innerHTML = '<span style="color:gold;font-size:40px">VÒNG MỚI!</span>'; });
socket.on('gameOver', d => { setTimeout(() => alert(`CHÚC MỪNG ${d.winner} THẮNG CỤC!`), 500); });

function renderHand() {
  const div = document.getElementById('hand');
  div.innerHTML = hand.map(c => {
    const red = ['♥','♦'].includes(c.slice(-1)) ? 'he' : '';
    return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
  }).join('');
}

function toggle(c) {
  if (selected.includes(c)) selected = selected.filter(x => x !== c);
  else selected.push(c);
  renderHand();
  document.getElementById('playBtn').disabled = selected.length === 0 || myIndex !== currentTurn;
}

function playSelected() {
  if (selected.length === 0 || myIndex !== currentTurn) return;
  socket.emit('playCards', { roomId, cards: selected });
  selected = [];
  renderHand();
}

function skipTurn() {
  if (myIndex !== currentTurn) return;
  socket.emit('skipTurn', { roomId });
}

function updateTurn() {
  const my = myIndex === currentTurn;
  document.getElementById('playBtn').disabled = !my || selected.length === 0;
  document.getElementById('skipBtn').disabled = !my;
  document.getElementById('status').innerHTML = my 
    ? '<span style="color:#ff1744; animation:blink 1s infinite">ĐẾN LƯỢT BẠN – ĐÁNH ĐI NGAY!</span>'
    : `Đợi <strong>${players[currentTurn] || 'người chơi'}</strong> đánh...`;
}

function updatePlayersList() {
  document.getElementById('players').innerHTML = players.map((n,i) => 
    `<p style="margin:8px;font-size:22px">${i===currentTurn?'→':''} ${i+1}. ${n}</p>`
  ).join('');
}
</script>
</body>
</html>
