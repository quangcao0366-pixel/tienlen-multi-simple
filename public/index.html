<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>CHÍ DŨNG CLUB - Tiến Lên Miền Nam</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{background:#040e06;overflow:hidden;height:100vh;font-family:'Segoe UI',sans-serif;color:#fff}
  .logo{position:fixed;top:12px;left:12px;font-size:38px;font-weight:900;color:#ffd700;z-index:9999;
    text-shadow:0 0 20px #ff0;animation:glow 2s infinite alternate}
  @keyframes glow{from{text-shadow:0 0 15px #ff0} to{text-shadow:0 0 40px #ff0}}

  #leaveBtn{position:fixed;top:12px;right:12px;padding:10px 24px;background:#ff1744;color:#fff;
    font-weight:900;border-radius:50px;border:none;cursor:pointer;z-index:9999;display:none;
    box-shadow:0 4px 15px rgba(255,23,68,0.6)}

  #joinForm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;width:100%;max-width:400px}
  #joinForm h1{font-size:72px;color:#ffd700;text-shadow:0 0 40px gold;margin-bottom:50px}
  input,#joinForm button{width:100%;padding:18px 20px;margin:12px 0;border-radius:30px;border:none;font-size:22px}
  input{background:#fff;color:#000}
  #joinForm button{background:#ffd700;color:#000;font-weight:900;cursor:pointer}

  #gameArea{display:none;width:100vw;height:100vh;position:relative;
    background:radial-gradient(circle at center,#0a3d1a 0%,#000 70%)}

  .table{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:90vmin;height:75vmin;background:radial-gradient(#1e8c3a,#0a3d1a);
    border-radius:50%;border:12px solid #ffd700;box-shadow:0 0 100px rgba(0,255,0,0.6)}

  .hand{position:absolute;display:flex;justify-content:center;align-items:flex-end;flex-wrap:nowrap}
  #hand0{bottom:2vh;left:50%;transform:translateX(-50%);gap:0.7vmin;padding:0 3vmin;height:24vh}
  #hand1{top:4vh;right:4vw;flex-direction:column;gap:0.7vmin}
  #hand2{top:4vh;left:50%;transform:translateX(-50%);gap:0.7vmin}
  #hand3{top:4vh;left:4vw;flex-direction:column;gap:0.7vmin}

  .card{
    width:8.5vmin;height:12.2vmin;background:#fff;color:#000;border-radius:10px;
    border:3px solid #000;box-shadow:0 8px 25px rgba(0,0,0,0.8);cursor:pointer;
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    font-weight:bold;transition:all .3s;position:relative;overflow:hidden;
    flex-shrink:0;
  }
  .card.he{color:#d50000}
  .card.selected{transform:translateY(-11vh)!important;box-shadow:0 60px 100px gold;z-index:99}
  .card .rank{font-size:2.9vmin}
  .card .suit{font-size:5vmin}
  .card.back{background:#0a3d1a;border:4px solid #ffd700;
    background-image:repeating-linear-gradient(45deg,#0a3d1a 0,#104d22 10px,#0a3d1a 20px)}
  .card.back::after{content:"CHÍ DŨNG";position:absolute;bottom:4px;right:4px;
    font-size:1.4vmin;color:#ffd700;font-weight:900}

  #playedArea{
    position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:82vmin;height:46vmin;display:flex;flex-wrap:wrap;gap:5vmin;
    justify-content:center;align-items:center;padding:20px;overflow:hidden;
  }

  /* ĐÃ SỬA HOÀN TOÀN – BÀI ĐÁNH LÊN BÀN HIỆN RÕ 100% CẢ PC & MOBILE */
  .played-card{
    width:15vmin;height:21vmin;background:#fff;border-radius:15px;
    border:5px solid #000;box-shadow:0 30px 70px rgba(0,0,0,0.9);
    display:flex;flex-direction:column;align-items:center;justify-content:center;
    font-weight:900;position:relative;z-index:2;
    transform:rotate(var(--r,0deg));
    transition:all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }
  .played-card.he{color:#d50000}
  .played-card .rank{font-size:8vmin;line-height:1}
  .played-card .suit{font-size:10vmin;margin-top:-1vmin}

  .name{position:absolute;font-size:2.8vmin;font-weight:900;text-shadow:0 0 15px gold}
  #name0{bottom:18vh;left:50%;transform:translateX(-50%)}
  #name1{top:12vh;right:6vw}#name2{top:6vh;left:50%;transform:translateX(-50%)}
  #name3{top:12vh;left:6vw}

  #status{position:absolute;top:2vh;left:50%;transform:translateX(-50%);
    font-size:4vmin;font-weight:bold;color:#ffd700}

  #readyBtn{position:absolute;bottom:12vh;left:50%;transform:translateX(-50%);
    padding:2.5vh 12vw;background:#d50000;color:#fff;font-size:4.5vmin;border:none;
    border-radius:50px;font-weight:900;cursor:pointer}
  #readyBtn.ready{background:#00c853}

  #startGameBtn{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    padding:4vh 14vw;background:#ffeb3b;color:#d50000;font-size:5.5vmin;font-weight:900;
    border:none;border-radius:60px;cursor:pointer;animation:pulse 2s infinite;z-index:99;display:none}
  @keyframes pulse{0%,100%{box-shadow:0 20px 60px rgba(255,235,59,0.8)}50%{box-shadow:0 20px 90px rgba(255,235,59,1)}}

  .controls{position:absolute;bottom:2vh;left:50%;transform:translateX(-50%);display:flex;gap:6vw}
  .controls button{padding:2.5vh 11vw;background:#ffd700;color:#000;font-size:4.2vmin;
    font-weight:900;border:none;border-radius:50px;cursor:pointer;
    box-shadow:0 10px 30px rgba(0,0,0,0.7)}
  .controls button:disabled{opacity:0.5}

  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.4}}

  /* FIX MOBILE HOÀN TOÀN */
  @media (max-width:768px){
    #hand0{gap:0.4vmin !important;padding:0 1vmin;height:21vh}
    .card{width:8vmin;height:11.5vmin;flex-shrink:0}
    .card .rank{font-size:2.6vmin}
    .card .suit{font-size:4.5vmin}
    .card.selected{transform:translateY(-9vh)!important}
    .played-card{width:12vmin;height:17vmin}
    .played-card .rank{font-size:6.5vmin}
    .played-card .suit{font-size:8vmin}
    #playedArea{gap:3vmin;width:90vmin;height:50vmin}
  }
</style>
</head>
<body>

<div class="logo">CHÍ DŨNG CLUB</div>
<button id="leaveBtn" onclick="leaveRoom()">THOÁT PHÒNG</button>

<div id="joinForm">
  <h1>CHÍ DŨNG CLUB</h1>
  <input type="text" id="roomId" placeholder="ID phòng" value="123">
  <input type="text" id="playerName" placeholder="Tên anh em">
  <button onclick="joinRoom()">VÀO PHÒNG NGAY</button>
</div>

<div id="gameArea">
  <div id="status">Đang kết nối...</div>
  <div class="table">
    <div id="name2" class="name"></div><div id="hand2" class="hand"></div>
    <div id="name1" class="name"></div><div id="hand1" class="hand"></div>
    <div id="playedArea"><div style="color:#999;font-size:6vmin">Bàn bài trống</div></div>
    <div id="name3" class="name"></div><div id="hand3" class="hand"></div>
    <div id="name0" class="name">Bạn</div><div id="hand0" class="hand"></div>
  </div>
  <button id="readyBtn" onclick="toggleReady()">SẴN SÀNG</button>
  <button id="startGameBtn" onclick="startGame()">BẮT ĐẦU VÁN</button>
  <div class="controls">
    <button id="playBtn" onclick="playSelected()">ĐÁNH</button>
    <button id="skipBtn" onclick="skipTurn()">BỎ QUA</button>
  </div>
</div>

<script>
let hand=[],selected=[],myIndex=-1,currentTurn=-1,roomId='123',players=[],readyList=[],gameStarted=false,cardsLeft=[];
const socket=io();
const suitSymbol = {S:'♠', H:'♥', D:'♦', C:'♣'};

function joinRoom(){
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Anh Em';
  socket.emit('joinRoom',{roomId,playerName:name});
}

function startGame(){socket.emit('startGame',{roomId});}

socket.on('youJoined',d=>{
  myIndex=d.myIndex;
  document.getElementById('joinForm').style.display='none';
  document.getElementById('gameArea').style.display='block';
  document.getElementById('readyBtn').style.display='block';
  document.getElementById('leaveBtn').style.display='block';
});

socket.on('roomUpdate',d=>{
  players=d.names||[]; readyList=d.ready||[];
  document.getElementById('status').innerHTML=`Phòng ${roomId} • ${d.count}/4 anh em`;
  updateNames(); updateReadyButton(); renderHands();
  document.getElementById('startGameBtn').style.display=(!gameStarted && d.count>=2 && readyList.length===d.count && myIndex===0)?'block':'none';
});

socket.on('gameStarted',d=>{
  gameStarted=true; hand=d.hand||[]; currentTurn=d.currentTurn; selected=[];
  document.getElementById('readyBtn').style.display='none';
  document.getElementById('startGameBtn').style.display='none';
  document.getElementById('playedArea').innerHTML='<div style="color:#999;font-size:6vmin">Bàn bài trống</div>';
  renderHands(); updateTurn();
});

socket.on('gameOver',d=>{
  document.getElementById('playedArea').innerHTML=`<div style="color:#ffd700;font-size:10vmin">CHÚC MỪNG ${d.winner} THẮNG!</div>`;
  hand=[];selected=[];gameStarted=false;
  document.getElementById('readyBtn').style.display='block';
  document.getElementById('readyBtn').innerText='SẴN SÀNG';
  document.getElementById('readyBtn').classList.remove('ready');
  setTimeout(()=>{document.getElementById('playedArea').innerHTML='<div style="color:#999;font-size:6vmin">Bàn bài trống</div>';},5000);
});

socket.on('updateCardsLeft',d=>{cardsLeft=d.cardsLeft;renderHands();});

// SỬA DỨT ĐIỂM – BÀI ĐÁNH LÊN BÀN HIỆN RÕ 100%
socket.on('cardsPlayed',d=>{
  const area=document.getElementById('playedArea'); area.innerHTML='';
  d.cards.forEach((c,i)=>{
    const el=document.createElement('div');
    el.className='played-card'+(c.includes('H')||c.includes('D')?' he':'');
    const rot=Math.random()*40-20;
    el.style.setProperty('--r',rot+'deg');
    const rank=c.slice(0,-1)==='10'?'10':c.slice(0,-1);
    el.innerHTML=`<div class="rank">${rank}</div><div class="suit">${suitSymbol[c.slice(-1)]}</div>`;
    el.style.opacity='0';
    el.style.transform='translateY(200px) scale(0.3)';
    area.appendChild(el);
    setTimeout(()=>{el.style.transition='all 0.7s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
      el.style.opacity='1';
      el.style.transform=`translateY(0) rotate(${rot}deg) scale(1)`;
    },i*120);
  });
  if(d.playerIndex===myIndex){hand=hand.filter(x=>!d.cards.includes(x)); selected=[]; renderHands();}
  updateTurn();
});

socket.on('turnChanged',d=>{currentTurn=d.currentTurn;updateTurn();});

function toggleReady(){socket.emit('toggleReady',{roomId});}
function leaveRoom(){if(confirm('Thoát phòng?')){socket.emit('leaveRoom',{roomId});location.reload();}}
function skipTurn(){if(myIndex===currentTurn)socket.emit('skipTurn',{roomId});}
function playSelected(){
  if(selected.length&&myIndex===currentTurn){
    socket.emit('playCards',{roomId,cards:selected});
    selected=[];renderHands();
  }
}

function toggle(c){
  if(selected.includes(c)) selected=selected.filter(x=>x!==c);
  else selected.push(c);
  renderHands();
}

function updateReadyButton(){
  if(gameStarted)return;
  const b=document.getElementById('readyBtn');
  const r=readyList.includes(myIndex);
  b.innerText=r?'HỦY SẴN SÀNG':'SẴN SÀNG';
  b.classList.toggle('ready',r);
}

function renderHands(){
  document.getElementById('hand0').innerHTML=hand.map(c=>{
    const rank=c.slice(0,-1)==='10'?'10':c.slice(0,-1);
    const suit=c.slice(-1);
    const red=(suit==='H'||suit==='D')?'he':'';
    const sel=selected.includes(c)?' selected':'';
    return `<div class="card ${red}${sel}" onclick="toggle('${c}')">
      <div class="rank">${rank}</div>
      <div class="suit">${suitSymbol[suit]}</div>
    </div>`;
  }).join('');

  for(let i=1;i<=3;i++){
    const cnt=gameStarted?cardsLeft[(myIndex+i)%4]||0:0;
    document.getElementById(`hand${i}`).innerHTML=Array(cnt).fill('<div class="card back"></div>').join('');
  }
}

function updateNames(){
  for(let i=0;i<4;i++){
    const e=document.getElementById(`name${i}`);
    e.innerText=i===myIndex?'Bạn':(players[i]||'Đang chờ...');
    if(!gameStarted&&readyList.includes(i))e.innerText+=' Ready';
    e.style.color=i===currentTurn?'#ff1744':'#ffd700';
  }
}

function updateTurn(){
  const name=players[currentTurn]||'???';
  document.getElementById('status').innerHTML=myIndex===currentTurn
    ?'<span style="color:#ff1744;font-size:6vmin;animation:blink 1s infinite">ĐẾN LƯỢT BẠN!</span>'
    :`<strong style="color:#ffd700">${name} đang đánh...</strong>`;
  const myTurn=myIndex===currentTurn;
  document.getElementById('playBtn').disabled=!myTurn||selected.length===0;
  document.getElementById('skipBtn').disabled=!myTurn;
}
</script>
</body>
</html>
