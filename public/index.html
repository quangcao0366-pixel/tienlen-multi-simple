<script>
// THAY TOÀN BỘ PHẦN <script> BÊN DƯỚI BẰNG ĐOẠN NÀY (từ dòng let hand = ... đến hết)
let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [], readyList = [], gameStarted = false;
// THÊM DÒNG NÀY ĐỂ LƯU SỐ BÀI CÒN LẠI CỦA TỪNG NGƯỜI
let cardsLeft = [13,13,13,13];  

const socket = io();

function joinRoom() {
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Player' + Date.now().toString().slice(-4);
  socket.emit('joinRoom', { roomId, playerName: name });
}

socket.on('youJoined', data => {
  myIndex = data.myIndex;
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('readyBtn').style.display = 'block';
});

socket.on('roomUpdate', data => {
  players = data.names || [];
  readyList = data.ready || [];
  document.getElementById('status').innerHTML = `Phòng ${roomId} • ${data.count}/4 người`;
  updateReadyButton();
  renderHands();        // Quan trọng: cập nhật số lá khi có người vào/rời
  updateNames();
});

socket.on('gameStarted', data => {
  gameStarted = true;
  hand = data.hand || [];
  currentTurn = data.currentTurn;
  cardsLeft = [13,13,13,13];  // Reset lại 13 lá mỗi người
  if (myIndex >= 0) cardsLeft[myIndex] = hand.length;
  selected = [];
  document.getElementById('readyBtn').style.display = 'none';
  document.getElementById('playedArea').innerHTML = '<div style="color:#aaa;font-size:36px">Bàn bài trống</div>';
  renderHands();
  updateTurn();
});

// QUAN TRỌNG NHẤT: NHẬN CẬP NHẬT SỐ BÀI CÒN LẠI TỪ SERVER
socket.on('updateCardsLeft', data => {
  cardsLeft = data.cardsLeft;  // Server gửi mảng [13,12,13,11,...]
  renderHands();               // Cập nhật lại số lá ??? của mọi người
});

socket.on('cardsPlayed', data => {
  const area = document.getElementById('playedArea');
  area.innerHTML = '';
  data.cards.forEach(c => {
    const el = document.createElement('div');
    el.className = 'played-card';
    el.style.setProperty('--r', (Math.random()*40-20)+'deg');
    el.innerText = c;
    if (['♥','♦'].includes(c.slice(-1))) el.style.color = 'red';
    area.appendChild(el);
  });

  // Cập nhật tay mình
  if (data.playerIndex === myIndex) {
    hand = hand.filter(x => !data.cards.includes(x));
    selected = [];
  }
  
  renderHands();
  updateTurn();
});

socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); });
socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); });
socket.on('newRound', () => document.getElementById('playedArea').innerHTML = '<div style="color:gold;font-size:42px">VÒNG MỚI!</div>');
socket.on('gameOver', () => {
  setTimeout(() => location.reload(), 4000);
});

function toggleReady() {
  socket.emit('toggleReady', { roomId });
}

function updateReadyButton() {
  const btn = document.getElementById('readyBtn');
  if (readyList.length === 4 || gameStarted) {
    btn.style.display = 'none';
  } else {
    btn.style.display = 'block';
    const iAmReady = readyList.includes(myIndex);
    btn.innerText = iAmReady ? 'HỦY SẴN SÀNG' : 'SẴN SÀNG';
    btn.className = iAmReady ? 'ready' : '';
  }
}

// HÀM QUAN TRỌNG NHẤT – SỬA DỨT ĐIỂM 2 LỖI
function renderHands() {
  // Tay mình
  document.getElementById('hand0').innerHTML = hand.map(c => {
    const red = ['♥','♦'].includes(c.slice(-1)) ? 'he' : '';
    return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
  }).join('');

  // Tay 3 người khác – DỰA HOÀN TOÀN VÀO cardsLeft từ server
  for (let i = 1; i <= 3; i++) {
    const realIndex = (myIndex + i) % 4;  // Đảm bảo đúng thứ tự ghế
    const count = cardsLeft[realIndex] || 0;
    const html = Array(count).fill('<div class="card back">?</div>').join('');
    document.getElementById(`hand${i}`).innerHTML = html;
  }
}

function updateNames() {
  for (let i = 0; i < 4; i++) {
    const el = document.getElementById(`name${i}`);
    const name = i === myIndex ? 'Bạn' : (players[i] || '');
    el.innerText = name + (readyList.includes(i) ? ' Ready' : '');
    el.style.color = i === currentTurn ? '#ff1744' : '#ffca28';
  }
}

function toggle(c) {
  selected = selected.includes(c) ? selected.filter(x => x !== c) : [...selected, c];
  renderHands();
  document.getElementById('playBtn').disabled = selected.length === 0 || myIndex !== currentTurn;
}

function playSelected() {
  if (selected.length === 0 || myIndex !== currentTurn) return;
  socket.emit('playCards', { roomId, cards: selected });
}

function skipTurn() {
  if (myIndex !== currentTurn) return;
  socket.emit('skipTurn', { roomId });
}

function updateTurn() {
  const myTurn = myIndex === currentTurn;
  document.getElementById('playBtn').disabled = !myTurn || selected.length === 0;
  document.getElementById('skipBtn').disabled = !myTurn;
  document.getElementById('status').innerHTML = myTurn
    ? '<span style="color:#ff1744;animation:blink 1s infinite;font-size:44px">ĐẾN LƯỢT BẠN – ĐÁNH ĐI!</span>'
    : `Đợi <strong>${players[currentTurn] || '???'} đánh...</strong>`;
}
</script>
