<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiến Lên Miền Nam - 4 Người Sẵn Sàng Mới Chơi</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { margin:0; background:#0d4f1a; color:#fff; font-family:Arial; overflow:hidden; }
    #joinForm { text-align:center; padding-top:15vh; }
    input { padding:12px; width:220px; margin:8px; border-radius:8px; border:none; font-size:16px; }
    button { padding:12px 30px; background:#ffeb3b; color:#000; border:none; border-radius:8px; font-weight:bold; cursor:pointer; font-size:18px; }
    #gameArea { display:none; position:relative; width:100vw; height:100vh; }
    .table { position:absolute; width:900px; height:600px; background:#226f3a; border-radius:50%; top:50%; left:50%; transform:translate(-50%,-50%); box-shadow:0 0 30px rgba(0,0,0,0.8); }
    .hand { position:absolute; display:flex; justify-content:center; align-items:center; gap:6px; }
    #hand0 { bottom:15px; left:50%; transform:translateX(-50%); flex-wrap:nowrap; overflow-x:auto; max-width:95%; padding:5px; }
    #hand1 { top:20px; right:30px; flex-direction:column; }
    #hand2 { top:20px; left:50%; transform:translateX(-50%); }
    #hand3 { top:20px; left:30px; flex-direction:column; }
    .card { width:56px; height:78px; background:#fff; border:3px solid #333; border-radius:8px; display:flex; align-items:center; justify-content:center; font-weight:bold; font-size:18px; cursor:pointer; transition:all 0.2s; box-shadow:0 4px 8px rgba(0,0,0,0.4); }
    .card.he { color:red; }
    .card.selected { transform:translateY(-20px); box-shadow:0 15px 25px gold; }
    .card.back { background:#222; color:#222; }
    #playedArea { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); display:flex; flex-wrap:wrap; gap:12px; justify-content:center; align-items:center; width:400px; height:220px; }
    .played-card { width:70px; height:96px; background:white; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:28px; font-weight:bold; box-shadow:0 8px 20px rgba(0,0,0,0.6); transform:rotate(var(--r)); }
    .played-card.he { color:red; }
    .name { position:absolute; font-weight:bold; font-size:16px; }
    #name0 { bottom:100px; left:50%; transform:translateX(-50%); }
    #name1 { top:90px; right:40px; }
    #name2 { top:40px; left:50%; transform:translateX(-50%); }
    #name3 { top:90px; left:40px; }
    #status { position:absolute; top:10px; left:50%; transform:translateX(-50%); font-size:20px; font-weight:bold; }
    #readyBtn { position:absolute; bottom:80px; left:50%; transform:translateX(-50%); padding:14px 40px; background:#ff1744; color:white; font-size:20px; }
    #readyBtn.ready { background:#4caf50; }
    .controls { position:absolute; bottom:15px; left:50%; transform:translateX(-50%); }
    .controls button { padding:12px 35px; margin:0 10px; font-size:18px; }
    @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.4; } }
  </style>
</head>
<body>
  <div id="joinForm">
    <h1 style="color:#ffeb3b;font-size:48px;text-shadow:0 0 10px gold">Tiến Lên Miền Nam</h1>
    <input id="roomId" value="123" placeholder="ID phòng">
    <br>
    <input id="playerName" placeholder="Tên của bạn">
    <br><br>
    <button onclick="joinRoom()">THAM GIA PHÒNG</button>
  </div>

  <div id="gameArea">
    <div id="status">Phòng 123 • 1/4 người</div>
    <div class="table">
      <div id="name2" class="name"></div>
      <div id="hand2" class="hand"></div>
      <div id="name1" class="name"></div>
      <div id="hand1" class="hand"></div>
      <div id="playedArea"><div style="color:#aaa;font-size:36px">Bàn bài trống</div></div>
      <div id="name3" class="name"></div>
      <div id="hand3" class="hand"></div>
      <div id="name0" class="name">Bạn</div>
      <div id="hand0" class="hand"></div>
    </div>
    <button id="readyBtn" onclick="toggleReady()">SẴN SÀNG</button>
    <div class="controls">
      <button id="playBtn" onclick="playSelected()" disabled>ĐÁNH</button>
      <button id="skipBtn" onclick="skipTurn()" disabled>BỎ QUA</button>
    </div>
  </div>

  <script>
    let hand=[], selected=[], myIndex=-1, currentTurn=-1, roomId='123', players=[], readyList=[], gameStarted=false;
    let cardsLeft=[13,13,13,13];
    const socket = io();

    function joinRoom() {
      roomId = document.getElementById('roomId').value.trim() || '123';
      const name = document.getElementById('playerName').value.trim() || 'Người chơi';
      socket.emit('joinRoom', { roomId, playerName: name });
    }

    socket.on('youJoined', d => {
      myIndex = d.myIndex;
      document.getElementById('joinForm').style.display='none';
      document.getElementById('gameArea').style.display='block';
      document.getElementById('readyBtn').style.display='block';
    });

    socket.on('roomUpdate', d => {
      players = d.names || [];
      readyList = d.ready || [];
      document.getElementById('status').innerHTML = `Phòng ${roomId} • ${d.count}/4 người`;
      updateNames();
      updateReadyButton();
      renderHands();
    });

    socket.on('gameStarted', d => {
      gameStarted = true;
      hand = d.hand || [];
      currentTurn = d.currentTurn;
      selected = [];
      document.getElementById('readyBtn').style.display='none';
      document.getElementById('playedArea').innerHTML = '<div style="color:#aaa;font-size:36px">Bàn bài trống</div>';
      renderHands();
      updateTurn();
    });

    socket.on('updateCardsLeft', d => { cardsLeft = d.cardsLeft; renderHands(); });

    socket.on('cardsPlayed', d => {
      const area = document.getElementById('playedArea');
      area.innerHTML = '';
      d.cards.forEach(c => {
        const el = document.createElement('div');
        el.className = 'played-card' + (['♥','♦'].includes(c.slice(-1)) ? ' he' : '');
        el.style.setProperty('--r', (Math.random()*50-25)+'deg');
        el.innerText = c;
        area.appendChild(el);
      });
      if (d.playerIndex === myIndex) {
        hand = hand.filter(x => !d.cards.includes(x));
        selected = [];
        renderHands();
      }
      updateTurn();
    });

    socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); });
    socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); });
    socket.on('newRound', () => document.getElementById('playedArea').innerHTML = '<div style="color:gold;font-size:50px">VÒNG MỚI!</div>');
    socket.on('gameOver', d => {
      document.getElementById('playedArea').innerHTML = `<div style="color:#ffeb3b;font-size:52px">CHÚC MỪNG ${d.winner} THẮNG VÁN!</div>`;
      setTimeout(() => location.reload(), 7000);
    });

    function toggleReady() { socket.emit('toggleReady', roomId); }

    function updateReadyButton() {
      const btn = document.getElementById('readyBtn');
      if (gameStarted || players.length < 4) {
        btn.style.display = players.length === 4 ? 'block' : 'none';
      }
      if (players.length === 4) {
        const allReady = readyList.length === 4;
        btn.innerText = readyList.includes(myIndex) ? 'HỦY SẴN SÀNG' : 'SẴN SÀNG';
        btn.className = readyList.includes(myIndex) ? 'ready' : '';
        if (allReady) btn.style.display = 'none';
      }
    }

    function renderHands() {
      // Bài mình – đẹp, đều, có khoảng cách cố định
      document.getElementById('hand0').innerHTML = hand.map(c => {
        const red = ['♥','♦'].includes(c.slice(-1)) ? 'he' : '';
        return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
      }).join('');

      // 3 người khác
      for (let i=1; i<=3; i++) {
        const realIndex = (myIndex + i) % 4;
        const count = cardsLeft[realIndex] || 0;
        document.getElementById(`hand${i}`).innerHTML = Array(count).fill('<div class="card back">?</div>').join('');
      }
    }

    function updateNames() {
      for (let i=0; i<4; i++) {
        const el = document.getElementById(`name${i}`);
        el.innerText = i===myIndex ? 'Bạn' : (players[i] || '');
        if (readyList.includes(i)) el.innerText += ' ✓';
        el.style.color = i===currentTurn ? '#ff1744' : '#ffca28';
      }
    }

    function toggle(c) {
      selected = selected.includes(c) ? selected.filter(x=>x!==c) : [...selected, c];
      renderHands();
      document.getElementById('playBtn').disabled = selected.length===0 || myIndex!==currentTurn;
    }

    function playSelected() {
      if (selected.length===0 || myIndex!==currentTurn) return;
      socket.emit('playCards', { roomId, cards: selected });
    }

    function skipTurn() {
      if (myIndex!==currentTurn) return;
      socket.emit('skipTurn', roomId);
    }

    function updateTurn() {
      const myTurn = myIndex===currentTurn;
      document.getElementById('playBtn').disabled = !myTurn || selected.length===0;
      document.getElementById('skipBtn').disabled = !myTurn;
      document.getElementById('status').innerHTML = myTurn
        ? '<span style="color:#ff1744;animation:blink 1s infinite;font-size:46px">ĐẾN LƯỢT BẠN – ĐÁNH ĐI!</span>'
        : `Đợi <strong>${players[currentTurn]||'???'} đánh...</strong>`;
    }
  </script>
</body>
</html>
