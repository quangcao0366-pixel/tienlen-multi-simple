<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>CHÍ DŨNG CLUB - Tiến Lên Miền Nam</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  *{box-sizing:border-box}
  body{margin:0;background:#040e06;color:#fff;font-family:'Segoe UI',sans-serif;overflow:hidden;height:100vh;
    background:radial-gradient(circle at center,#0a3d1a,#000)}

  .logo{position:fixed;top:15px;left:25px;font-size:42px;font-weight:900;color:#ffd700;z-index:9999;
    text-shadow:0 0 15px #ff0,0 0 30px #ff0,0 0 60px #ff0;
    animation:neon 1.6s ease-in-out infinite alternate}
  @keyframes neon{from{text-shadow:0 0 10px #ff0,0 0 20px #ff0,0 0 40px #ff0}
                  to{text-shadow:0 0 20px #ff0,0 0 40px #ff0,0 0 80px #ff0}}

  #leaveBtn{position:fixed;top:18px;left:280px;padding:12px 32px;background:#ff1744;color:#fff;
    font-size:20px;font-weight:900;border:none;border-radius:50px;cursor:pointer;
    box-shadow:0 8px 25px rgba(255,23,68,0.6);z-index:9999;display:none;transition:all .3s}
  #leaveBtn:hover{transform:scale(1.1);background:#f50057}

  #joinForm{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;z-index:10;width:100%}
  #joinForm h1{font-size:76px;color:#ffd700;text-shadow:0 0 40px gold;margin-bottom:60px}
  input{padding:20px 35px;width:340px;max-width:80vw;margin:15px;border-radius:25px;border:none;font-size:24px;background:#fff;color:#000;
        box-shadow:0 10px 30px rgba(0,0,0,0.6);outline:none}
  #joinForm button{padding:24px 100px;max-width:90vw;background:#ffd700;color:#000;border:none;border-radius:50px;
        font-weight:900;font-size:32px;cursor:pointer;box-shadow:0 15px 40px rgba(0,0,0,0.7);transition:.3s}
  #joinForm button:hover{transform:scale(1.05)}

  #gameArea{display:none;width:100vw;height:100vh;position:relative;background:radial-gradient(ellipse at center,#1a5f38,#040e06)}
  .table{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);
    width:880px;height:640px;background:radial-gradient(#1e8c3a,#0a3d1a);border-radius:50%;
    box-shadow:0 0 130px rgba(0,255,0,0.6),inset 0 0 100px rgba(0,0,0,0.8);border:14px solid #ffd700}

  .hand{position:absolute;display:flex;justify-content:center;align-items:flex-end}
  #hand0{bottom:15px;left:50%;transform:translateX(-50%);gap:9px;padding:0 40px;max-width:97vw;overflow-x:auto;height:210px}
  #hand1{top:35px;right:55px;flex-direction:column;gap:7px}
  #hand2{top:35px;left:50%;transform:translateX(-50%);gap:9px}
  #hand3{top:35px;left:55px;flex-direction:column;gap:7px}

  .card{width:76px;height:110px;background:#fff;color:#000;border-radius:13px;border:4px solid #000;
    box-shadow:0 12px 35px rgba(0,0,0,0.9);position:relative;cursor:pointer;transition:all .3s;
    display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:bold;user-select:none;
    margin-bottom:10px}
  .card.he{color:#e91e63}
  .card.selected{transform:translateY(-105px);box-shadow:0 70px 120px gold;z-index:999;overflow:visible}
  .card .rank{font-size:32px;margin-bottom:3px}
  .card .suit{font-size:52px}
  .card.back{background:#0a3d1a;border:5px solid #ffd700;
    background-image:repeating-linear-gradient(45deg,#0a3d1a 0,#104d22 14px,#0a3d1a 28px)}
  .card.back::after{content:"CHÍ DŨNG";position:absolute;bottom:8px;right:8px;font-size:12px;color:#ffd700;
    font-weight:900;text-shadow:1px 1px 4px #000}

  #playedArea{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:480px;height:320px;
    display:flex;flex-wrap:wrap;gap:25px;justify-content:center;align-items:center}
  .played-card{width:96px;height:134px;background:#fff;color:#000;border-radius:15px;
    box-shadow:0 20px 60px rgba(0,0,0,0.9);transform:rotate(var(--r));
    display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:bold}
  .played-card.he{color:#e91e63}
  .played-card .rank{font-size:52px}
  .played-card .suit{font-size:64px;margin-top:-10px}

  .name{position:absolute;font-weight:900;font-size:24px;text-shadow:0 0 18px gold}
  #name0{bottom:150px;left:50%;transform:translateX(-50%)}
  #name1{top:130px;right:70px}#name2{top:65px;left:50%;transform:translateX(-50%)}
  #name3{top:130px;left:70px}

  #status{position:absolute;top:30px;left:50%;transform:translateX(-50%);font-size:32px;font-weight:bold;text-shadow:0 0 18px #fff}

  #readyBtn{position:absolute;bottom:120px;left:50%;transform:translateX(-50%);
    padding:26px 120px;background:#d50000;color:#fff;font-size:36px;border:none;border-radius:50px;
    box-shadow:0 18px 50px rgba(0,0,0,0.8);font-weight:900;cursor:pointer;display:none}
  #readyBtn.ready{background:#00c853}

  .controls{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);display:flex;gap:40px}
  .controls button{padding:24px 90px;background:#ffd700;color:#000;font-weight:900;font-size:28px;
    border:none;border-radius:50px;cursor:pointer;box-shadow:0 15px 40px rgba(0,0,0,0.7);transition:.3s}
  .controls button:hover{transform:scale(1.08)}
  .controls button:disabled{opacity:0.5;cursor:not-allowed}

  @keyframes blink{0%,100%{opacity:1}50%{opacity:0.3}}

  /* RESPONSIVE MOBILE - SỬA ĐẸP HƠN, THẤY ĐẦY ĐỦ BÀI, KHÔNG RỐI MẮT */
  @media screen and (max-width: 768px) {
    .logo{font-size:32px;top:10px;left:15px}
    #joinForm h1{font-size:52px;margin-bottom:40px}
    input{width:85vw;font-size:20px;padding:16px 20px}
    #joinForm button{width:85vw;padding:18px 30px;font-size:26px}

    .table{width:95vw;height:75vh;border-radius:40%;border-width:8px}
    #hand0{gap:6px;padding:0 20px;height:190px;bottom:10px}  /* Tăng height, giảm gap */
    .card{width:64px;height:95px;margin-bottom:8px}  /* Card nhỏ hơn */
    .card .rank{font-size:26px}
    .card .suit{font-size:44px}
    .card.selected{transform:translateY(-85px)}  /* Nhấc thấp hơn một chút */
    #playedArea{width:90vw;height:220px;gap:12px}  /* Giảm gap */
    .played-card{width:80px;height:110px}
    .played-card .rank{font-size:42px}
    .played-card .suit{font-size:52px}
    .name{font-size:20px}
    #status{font-size:26px;top:15px}
    #readyBtn{padding:20px 60px;font-size:30px;bottom:90px}
    .controls{gap:20px;bottom:15px}
    .controls button{padding:20px 50px;font-size:24px}
    #name0{bottom:130px}
    #name1{top:110px;right:30px}#name2{top:40px}#name3{top:110px;left:30px}
    #leaveBtn{left:220px;font-size:18px;padding:10px 25px;top:15px}
  }

  @media screen and (max-width: 480px) {
    .logo{font-size:28px}
    #joinForm h1{font-size:40px}
    input{width:92vw;font-size:18px;padding:14px 18px}
    #joinForm button{width:92vw;font-size:22px;padding:16px 25px}
    .table{width:98vw;height:70vh;border-radius:30%}
    #hand0{gap:4px;padding:0 10px;height:170px;bottom:5px}
    .card{width:56px;height:85px}
    .card .rank{font-size:22px}
    .card .suit{font-size:38px}
    .card.selected{transform:translateY(-70px)}
    #playedArea{width:95vw;height:200px;gap:8px}
    .played-card{width:70px;height:95px}
    .played-card .rank{font-size:36px}
    .played-card .suit{font-size:46px}
    .name{font-size:16px}
    #status{font-size:22px;top:10px}
    #readyBtn{padding:18px 40px;font-size:26px}
    .controls{gap:10px}
    .controls button{padding:16px 30px;font-size:20px}
  }

  /* Landscape cho tablet/mobile ngang */
  @media screen and (max-height: 600px) and (orientation: landscape) {
    .table{height:85vh;width:75vw}
    #hand0{height:140px}
    #playedArea{height:250px}
  }

  /* High DPI screens (Retina) */
  @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .card{border-width:2px}
    .played-card{border-radius:12px}
  }
</style>
</head>
<body>

<div class="logo">CHÍ DŨNG CLUB</div>
<button id="leaveBtn" onclick="leaveRoom()">THOÁT PHÒNG</button>

<div id="joinForm">
  <h1>CHÍ DŨNG CLUB</h1>
  <input type="text" id="roomId" value="123" placeholder="ID phòng">
  <br>
  <input type="text" id="playerName" placeholder="Tên anh em">
  <br><br>
  <button onclick="joinRoom()">VÀO PHÒNG NGAY</button>
</div>

<div id="gameArea">
  <div id="status">Phòng 123 • 0/4 anh em</div>
  <div class="table">
    <div id="name2" class="name"></div><div id="hand2" class="hand"></div>
    <div id="name1" class="name"></div><div id="hand1" class="hand"></div>
    <div id="playedArea"><div style="color:#999;font-size:48px">Bàn bài trống</div></div>
    <div id="name3" class="name"></div><div id="hand3" class="hand"></div>
    <div id="name0" class="name">Bạn</div><div id="hand0" class="hand"></div>
  </div>
  <button id="readyBtn" onclick="toggleReady()">SẴN SÀNG</button>
  <div class="controls">
    <button id="playBtn" onclick="playSelected()">ĐÁNH</button>
    <button id="skipBtn" onclick="skipTurn()">BỎ QUA</button>
  </div>
</div>

<script>
let hand=[],selected=[],myIndex=-1,currentTurn=-1,roomId='123',players=[],readyList=[],gameStarted=false,cardsLeft=[0,0,0,0];
const socket=io();
const suitSymbol = {S:'♠', H:'♥', D:'♦', C:'♣'};

function getCardHTML(c){
  const rank = c.slice(0,-1)==='10'?'10':c.slice(0,-1);
  const suit = c.slice(-1);
  const red = (suit==='H'||suit==='D')?'he':'';
  const sel = selected.includes(c)?'selected':'';
  return `<div class="card ${red} ${sel}" onclick="toggle('${c}')">
    <div class="rank">${rank}</div>
    <div class="suit">${suitSymbol[suit]}</div>
  </div>`;
}

function joinRoom(){
  roomId = document.getElementById('roomId').value.trim()||'123';
  const name = document.getElementById('playerName').value.trim()||'Anh Em';
  socket.emit('joinRoom',{roomId,playerName:name});
}

socket.on('youJoined', d => {
  myIndex = d.myIndex;
  document.getElementById('joinForm').style.display='none';
  document.getElementById('gameArea').style.display='block';
  document.getElementById('readyBtn').style.display='block';
  document.getElementById('leaveBtn').style.display='block';
});

socket.on('roomUpdate',d=>{
  players=d.names||[]; readyList=d.ready||[];
  document.getElementById('status').innerHTML=`Phòng ${roomId} • ${d.count}/4 anh em`;
  updateNames(); updateReadyButton(); renderHands();
});

socket.on('gameStarted',d=>{
  gameStarted=true; hand=d.hand||[]; currentTurn=d.currentTurn; selected=[];
  document.getElementById('readyBtn').style.display='none';
  document.getElementById('playedArea').innerHTML='<div style="color:#999;font-size:48px">Bàn bài trống</div>';
  renderHands(); updateTurn();
});

socket.on('gameOver', d => {
  document.getElementById('playedArea').innerHTML=`<div style="color:#ffd700;font-size:80px">CHÚC MỪNG ${d.winner} THẮNG!</div>`;
  hand = []; selected = []; gameStarted = false;
  document.getElementById('readyBtn').style.display = 'block';
  document.getElementById('readyBtn').innerText = 'SẴN SÀNG';
  document.getElementById('readyBtn').className = '';
  setTimeout(() => {
    document.getElementById('playedArea').innerHTML='<div style="color:#999;font-size:48px">Bàn bài trống</div>';
  }, 5000);
});

socket.on('updateCardsLeft',d=>{cardsLeft=d.cardsLeft; renderHands();});
socket.on('cardsPlayed',d=>{
  const area=document.getElementById('playedArea'); area.innerHTML='';
  d.cards.forEach(c=>{
    const el=document.createElement('div');
    el.className='played-card'+(c.includes('H')||c.includes('D')?' he':'');
    el.style.setProperty('--r',(Math.random()*40-20)+'deg');
    const rank=c.slice(0,-1)==='10'?'10':c.slice(0,-1);
    const suit=c.slice(-1);
    el.innerHTML=`<div class="rank">${rank}</div><div class="suit">${suitSymbol[suit]}</div>`;
    area.appendChild(el);
  });
  if(d.playerIndex===myIndex){hand=hand.filter(x=>!d.cards.includes(x)); selected=[]; renderHands();}
  updateTurn();
});
socket.on('turnChanged',d=>{currentTurn=d.currentTurn; updateTurn();});
socket.on('newRound',()=>{document.getElementById('playedArea').innerHTML='<div style="color:gold;font-size:70px">VÒNG MỚI!</div>';});

function toggleReady(){socket.emit('toggleReady',{roomId});}
function leaveRoom(){
  if(confirm('Thoát khỏi phòng này?')) {
    socket.emit('leaveRoom',{roomId});
    location.reload();
  }
}

function updateReadyButton(){
  if(gameStarted) return;
  const b=document.getElementById('readyBtn');
  const r=readyList.includes(myIndex);
  b.innerText=r?'HỦY SẴN SÀNG':'SẴN SÀNG';
  b.className=r?'ready':'';
}

function renderHands(){
  document.getElementById('hand0').innerHTML=hand.map(getCardHTML).join('');
  for(let i=1;i<=3;i++){
    const cnt=gameStarted?cardsLeft[(myIndex+i)%4]:0;
    document.getElementById(`hand${i}`).innerHTML=Array(cnt).fill('<div class="card back"></div>').join('');
  }
}

function updateNames(){
  for(let i=0;i<4;i++){
    const e=document.getElementById(`name${i}`);
    e.innerText=i===myIndex?'Bạn':(players[i]||'Đang chờ...');
    if(readyList.includes(i) && !gameStarted) e.innerText+=' Ready';
    e.style.color=i===currentTurn?'#ff1744':'#ffd700';
  }
}

function toggle(c){
  selected=selected.includes(c)?selected.filter(x=>x!==c):[...selected,c];
  renderHands();
  document.getElementById('playBtn').disabled=selected.length===0||myIndex!==currentTurn;
}
function playSelected(){
  if(selected.length && myIndex===currentTurn){
    socket.emit('playCards',{roomId,cards:selected});
    selected=[]; renderHands();
  }
}
function skipTurn(){
  if(myIndex===currentTurn) socket.emit('skipTurn',{roomId});
}
function updateTurn(){
  const my=myIndex===currentTurn;
  document.getElementById('playBtn').disabled=!my||selected.length===0;
  document.getElementById('skipBtn').disabled=!my;
  document.getElementById('status').innerHTML=my
    ?'<span style="color:#ff1744;animation:blink 1s infinite;font-size:60px">ĐẾN LƯỢT BẠN!</span>'
    :`Đợi <strong>${players[currentTurn]||'???'}</strong> đánh...`;
}
</script>
</body>
</html>
