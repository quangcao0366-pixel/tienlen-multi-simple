<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tiến Lên Miền Nam - Multiplayer</title>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    body { margin: 0; background: #0d4f1a; color: white; font-family: Arial; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
    #joinForm, #gameArea { text-align: center; }
    input { padding: 10px; margin: 5px; width: 200px; }
    button { padding: 10px 20px; margin: 5px; background: #4caf50; color: white; border: none; cursor: pointer; }
    button:disabled { background: #ccc; }
    button.ready { background: #ffeb3b; color: black; }
    #status { font-size: 18px; margin: 10px; }
    .table { position: relative; width: 800px; height: 600px; background: #226f1a; border-radius: 20px; margin: 20px auto; }
    .hand { position: absolute; display: flex; justify-content: center; }
    #hand0 { bottom: 20px; left: 50%; transform: translateX(-50%); }
    #hand1 { top: 20px; right: 20px; flex-direction: column-reverse; }
    #hand2 { top: 20px; left: 50%; transform: translateX(-50%); flex-direction: row-reverse; }
    #hand3 { bottom: 20px; left: 20px; flex-direction: column-reverse; }
    .card { width: 50px; height: 70px; border: 2px solid #333; border-radius: 8px; background: white; color: black; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; margin: 2px; cursor: pointer; transition: transform 0.2s; }
    .card.he { color: red; }
    .card.selected { transform: scale(1.1); box-shadow: 0 0 10px gold; }
    .card.back { background: #333; color: #333; }
    #playedArea { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-wrap: wrap; justify-content: center; width: 300px; height: 200px; }
    .played-card { width: 60px; height: 80px; transform: rotate(var(--r, 0deg)); margin: 10px; }
    .name { position: absolute; font-size: 14px; }
    #name0 { bottom: 100px; left: 50%; transform: translateX(-50%); }
    #name1 { top: 100px; right: 50px; }
    #name2 { top: 50px; left: 50%; transform: translateX(-50%); }
    #name3 { bottom: 100px; left: 50px; }
    @keyframes blink { 0%, 50% { opacity: 1; } 51%, 100% { opacity: 0.5; } }
    .controls { position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); }
  </style>
</head>
<body>
  <div id="joinForm">
    <h1>Tiến Lên Miền Nam Multiplayer</h1>
    <input id="roomId" placeholder="Room ID (mặc định: 123)" value="123">
    <br>
    <input id="playerName" placeholder="Tên của bạn">
    <br>
    <button onclick="joinRoom()">Tham gia</button>
  </div>
  <div id="gameArea" style="display:none;">
    <div id="status">Đang kết nối...</div>
    <div class="table">
      <div id="name2" class="name"></div>
      <div id="hand2" class="hand"></div>
      <div id="name1" class="name"></div>
      <div id="hand1" class="hand"></div>
      <div id="playedArea"></div>
      <div id="name3" class="name"></div>
      <div id="hand3" class="hand"></div>
      <div id="name0" class="name"></div>
      <div id="hand0" class="hand"></div>
    </div>
    <button id="readyBtn" onclick="toggleReady()" style="display:none;">SẴN SÀNG</button>
    <div class="controls">
      <button id="playBtn" onclick="playSelected()" disabled>ĐÁNH</button>
      <button id="skipBtn" onclick="skipTurn()" disabled>BỎ QUA</button>
    </div>
  </div>

  <script>
    let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [], gameStarted = false;
    let cardsLeft = [13,13,13,13];

    const socket = io({ reconnectionAttempts: 5, timeout: 20000 });

    function joinRoom() {
      roomId = document.getElementById('roomId').value.trim() || '123';
      const name = document.getElementById('playerName').value.trim() || 'Khách' + Date.now().toString().slice(-3);
      socket.emit('joinRoom', { roomId, playerName: name });
    }

    socket.on('connect', () => console.log('Connected to server'));
    socket.on('disconnect', () => document.getElementById('status').innerHTML = '<span style="color:#ff1744">Mất kết nối... đang thử lại</span>');

    socket.on('youJoined', data => {
      myIndex = data.myIndex;
      document.getElementById('joinForm').style.display = 'none';
      document.getElementById('gameArea').style.display = 'block';
      document.getElementById('status').innerHTML = `Phòng ${roomId} • 1/4 người`;
    });

    socket.on('roomUpdate', data => {
      players = data.names || [];
      document.getElementById('status').innerHTML = `Phòng ${roomId} • ${data.count}/4 người`;
      updateNames();
      renderHands();
    });

    socket.on('gameStarted', data => {
      gameStarted = true;
      hand = data.hand || [];
      currentTurn = data.currentTurn;
      selected = [];
      document.getElementById('playedArea').innerHTML = '<div style="color:#aaa;font-size:36px">Bàn bài trống</div>';
      renderHands();
      updateTurn();
    });

    socket.on('updateCardsLeft', data => {
      cardsLeft = data.cardsLeft;
      renderHands();
    });

    socket.on('cardsPlayed', data => {
      const area = document.getElementById('playedArea');
      area.innerHTML = '';
      data.cards.forEach(c => {
        const el = document.createElement('div');
        el.className = 'played-card';
        el.style.setProperty('--r', (Math.random()*40-20)+'deg');
        el.innerText = c;
        if (['♥','♦'].includes(c.slice(-1))) el.style.color = 'red';
        area.appendChild(el);
      });
      if (data.playerIndex === myIndex) {
        hand = hand.filter(x => !data.cards.includes(x));
        selected = [];
        renderHands();
      }
      updateTurn();
    });

    socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); });
    socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); });
    socket.on('newRound', () => document.getElementById('playedArea').innerHTML = '<div style="color:gold;font-size:50px">VÒNG MỚI!</div>');
    socket.on('gameOver', d => {
      document.getElementById('playedArea').innerHTML = `<div style="color:#ffeb3b;font-size:50px">CHÚC MỪNG ${d.winner} THẮNG!</div>`;
      setTimeout(() => location.reload(), 6000);
    });

    function renderHands() {
      document.getElementById('hand0').innerHTML = hand.map(c => {
        const red = ['♥','♦'].includes(c.slice(-1)) ? 'he' : '';
        return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
      }).join('');
      for (let i = 1; i <= 3; i++) {
        const realIndex = (myIndex + i) % 4;
        const count = cardsLeft[realIndex] || 0;
        document.getElementById(`hand${i}`).innerHTML = Array(count).fill('<div class="card back">?</div>').join('');
      }
    }

    function updateNames() {
      for (let i = 0; i < 4; i++) {
        const el = document.getElementById(`name${i}`);
        el.innerText = i === myIndex ? 'Bạn' : (players[i] || 'Đang chờ...');
        el.style.color = i === currentTurn ? '#ff1744' : '#ffca28';
      }
    }

    function toggle(c) {
      selected = selected.includes(c) ? selected.filter(x => x !== c) : [...selected, c];
      renderHands();
      document.getElementById('playBtn').disabled = selected.length === 0 || myIndex !== currentTurn;
    }

    function playSelected() {
      if (selected.length === 0 || myIndex !== currentTurn) return;
      socket.emit('playCards', { roomId, cards: selected });
      selected = [];
      renderHands();
    }

    function skipTurn() {
      if (myIndex !== currentTurn) return;
      socket.emit('skipTurn', { roomId });
    }

    function updateTurn() {
      const myTurn = myIndex === currentTurn;
      document.getElementById('playBtn').disabled = !myTurn || selected.length === 0;
      document.getElementById('skipBtn').disabled = !myTurn;
      document.getElementById('status').innerHTML = myTurn
        ? '<span style="color:#ff1744;animation:blink 1s infinite;font-size:44px">ĐẾN LƯỢT BẠN – ĐÁNH ĐI!</span>'
        : `Đợi <strong>${players[currentTurn] || '???'} đánh...</strong>`;
    }

    function toggleReady() {
      socket.emit('toggleReady', { roomId });
    }
  </script>
</body>
</html>
