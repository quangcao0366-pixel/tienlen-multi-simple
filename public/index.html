<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tiến Lên Miền Nam Multiplayer</title>
<style>
  body {margin:0; font-family:Arial; background:#0b6623; color:white; text-align:center; padding:20px;}
  h1 {margin:10px; color:#ffca28;}
  input, button {padding:12px; margin:5px; font-size:16px; border-radius:8px;}
  button {background:#ffca28; border:none; cursor:pointer; font-weight:bold;}
  #gameArea {max-width:1000px; margin:0 auto;}
  #table {background:#1b5e20; padding:30px; border-radius:20px; min-height:120px; margin:20px 0; font-size:40px;}
  #hand {display:flex; flex-wrap:wrap; justify-content:center; gap:10px; margin:20px 0;}
  .card {background:white; color:black; padding:15px 8px; border-radius:10px; cursor:pointer; font-weight:bold; user-select:none; transition:all .2s; width:60px; font-size:20px; box-shadow:0 4px 8px rgba(0,0,0,0.3);}
  .card.selected {background:#ffd700; transform:translateY(-25px); box-shadow:0 15px 30px gold;}
  .card.he {color:red;}
  #controls button {padding:16px 35px; font-size:22px; margin:15px;}
  #status {font-size:26px; font-weight:bold; margin:20px; color:#ffca28;}
</style>
</head>
<body>
<h1>Tiến Lên Miền Nam Multiplayer</h1>

<div id="joinForm">
  <input id="roomId" placeholder="ID phòng (vd: 123)" value="123">
  <input id="playerName" placeholder="Tên của bạn">
  <button onclick="joinRoom()">VÀO PHÒNG</button>
</div>

<div id="gameArea" style="display:none">
  <div id="status">Đang chờ 4 người...</div>
  <div id="players"></div>
  <div id="table">Bàn bài trống</div>
  <div id="controls">
    <button id="playBtn" disabled>ĐÁNH BÀI</button>
    <button id="skipBtn" disabled>BỎ LƯỢT</button>
  </div>
  <div id="hand"></div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
// === TẤT CẢ BIẾN TOÀN CỤC ĐƯỢC KHAI BÁO ĐẦU TIÊN ===
let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [];

const socket = io();

function joinRoom() {
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Người chơi';
  socket.emit('joinRoom', { roomId, playerName: name });
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
}

// Nhận thông tin khi vào phòng
socket.on('youJoined', data => { myIndex = data.myIndex; });
socket.on('roomUpdate', data => {
  players = data.names || [];
  document.getElementById('status').innerText = `Đang có ${data.count}/4 người`;
});

// Bắt đầu ván mới
socket.on('gameStarted', data => {
  hand = data.hand;
  myIndex = data.myIndex;
  currentTurn = data.currentTurn;
  players = data.players;
  document.getElementById('status').innerHTML = `<span style="color:gold">VÁN ${data.vanSo} – ${players[currentTurn]} đánh trước!</span>`;
  renderHand();
  updateTurn();
  updatePlayersList();
  document.getElementById('table').innerHTML = 'Bàn bài trống';
});

// Cập nhật lượt
socket.on('turnChanged', data => { currentTurn = data.currentTurn; updateTurn(); updatePlayersList(); });
socket.on('turnSkipped', data => { currentTurn = data.nextTurn; updateTurn(); updatePlayersList(); });

// Các event khác
socket.on('cardsPlayed', data => {
  document.getElementById('table').innerHTML = data.cards.map(c => `<span style="margin:10px;font-size:50px">${c}</span>`).join('');
  updateTurn();
  updatePlayersList();
});

socket.on('newRound', () => {
  document.getElementById('table').innerHTML = '<span style="color:#ffca28">VÒNG MỚI – AI CŨNG ĐÁNH ĐƯỢC!</span>';
});

socket.on('gameOver', data => {
  setTimeout(() => alert(`CHÚC MỪNG ${data.winner} ĂN CỤC! Ván mới sau 5 giây...`), 600);
});

// Hàm giao diện
function renderHand() {
  const div = document.getElementById('hand');
  div.innerHTML = hand.map(card => {
    const isRed = ['♥','♦'].includes(card.slice(-1));
    return `<div class="card ${isRed?'he':''} ${selected.includes(card)?'selected':''}" onclick="toggle('${card}')">${card}</div>`;
  }).join('');
}

function toggle(card) {
  if (selected.includes(card)) selected = selected.filter(c => c !== card);
  else selected.push(card);
  renderHand();
  document.getElementById('playBtn').disabled = selected.length === 0 || myIndex !== currentTurn;
}

function playSelected() {
  if (selected.length === 0 || myIndex !== currentTurn) return;
  socket.emit('playCards', { roomId, cards: selected });
  selected = [];
  renderHand();
}

function skipTurn() {
  if (myIndex !== currentTurn) return;
  socket.emit('skipTurn', { roomId });
}

function updateTurn() {
  const isMyTurn = myIndex === currentTurn;
  document.getElementById('playBtn').disabled = !isMyTurn || selected.length === 0;
  document.getElementById('skipBtn').disabled = !isMyTurn;
  document.getElementById('status').innerHTML = isMyTurn 
    ? '<span style="color:gold; font-size:30px">ĐẾN LƯỢT BẠN – ĐÁNH ĐI!</span>'
    : `Đợi <strong>${players[currentTurn] || 'người chơi'}</strong> đánh...`;
}

function updatePlayersList() {
  document.getElementById('players').innerHTML = players.map((n, i) => 
    `<p style="margin:8px; font-size:20px">${i===currentTurn?'→':''} ${i+1}. ${n}</p>`
  ).join('');
}
</script>
</body>
</html>
