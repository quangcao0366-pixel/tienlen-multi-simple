<script>
let hand = [], selected = [], myIndex = -1, currentTurn = -1, roomId = '123', players = [], gameStarted = false;
let cardsLeft = [13,13,13,13];

const socket = io({ reconnectionAttempts: 5, timeout: 20000 });

function joinRoom() {
  roomId = document.getElementById('roomId').value.trim() || '123';
  const name = document.getElementById('playerName').value.trim() || 'Khách' + Date.now().toString().slice(-3);
  socket.emit('joinRoom', { roomId, playerName: name });
}

socket.on('connect', () => console.log('Connected to server'));
socket.on('disconnect', () => document.getElementById('status').innerHTML = '<span style="color:#ff1744">Mất kết nối... đang thử lại</span>');

socket.on('youJoined', data => {
  myIndex = data.myIndex;
  document.getElementById('joinForm').style.display = 'none';
  document.getElementById('gameArea').style.display = 'block';
  document.getElementById('status').innerHTML = `Phòng ${roomId} • 1/4 người`;
});

socket.on('roomUpdate', data => {
  players = data.names || [];
  document.getElementById('status').innerHTML = `Phòng ${roomId} • ${data.count}/4 người`;
  updateNames();
  renderHands();
});

socket.on('gameStarted', data => {
  gameStarted = true;
  hand = data.hand || [];
  currentTurn = data.currentTurn;
  selected = [];
  document.getElementById('playedArea').innerHTML = '<div style="color:#aaa;font-size:36px">Bàn bài trống</div>';
  renderHands();
  updateTurn();
});

socket.on('updateCardsLeft', data => {
  cardsLeft = data.cardsLeft;
  renderHands();
});

socket.on('cardsPlayed', data => {
  const area = document.getElementById('playedArea');
  area.innerHTML = '';
  data.cards.forEach(c => {
    const el = document.createElement('div');
    el.className = 'played-card';
    el.style.setProperty('--r', (Math.random()*40-20)+'deg');
    el.innerText = c;
    if (['♥','♦'].includes(c.slice(-1))) el.style.color = 'red';
    area.appendChild(el);
  });
  if (data.playerIndex === myIndex) {
    hand = hand.filter(x => !data.cards.includes(x));
    selected = [];
    renderHands();
  }
  updateTurn();
});

socket.on('turnChanged', d => { currentTurn = d.currentTurn; updateTurn(); });
socket.on('turnSkipped', d => { currentTurn = d.nextTurn; updateTurn(); });
socket.on('newRound', () => document.getElementById('playedArea').innerHTML = '<div style="color:gold;font-size:50px">VÒNG MỚI!</div>');
socket.on('gameOver', d => {
  document.getElementById('playedArea').innerHTML = `<div style="color:#ffeb3b;font-size:50px">CHÚC MỪNG ${d.winner} THẮNG!</div>`;
  setTimeout(() => location.reload(), 6000);
});

function renderHands() {
  // Tay mình
  document.getElementById('hand0').innerHTML = hand.map(c => {
    const red = ['♥','♦'].includes(c.slice(-1)) ? 'he' : '';
    return `<div class="card ${red} ${selected.includes(c)?'selected':''}" onclick="toggle('${c}')">${c}</div>`;
  }).join('');

  // Tay 3 người khác
  for (let i = 1; i <= 3; i++) {
    const realIndex = (myIndex + i) % 4;
    const count = cardsLeft[realIndex] || 0;
    document.getElementById(`hand${i}`).innerHTML = Array(count).fill('<div class="card back">?</div>').join('');
  }
}

function updateNames() {
  for (let i = 0; i < 4; i++) {
    const el = document.getElementById(`name${i}`);
    el.innerText = i === myIndex ? 'Bạn' : (players[i] || 'Đang chờ...');
    el.style.color = i === currentTurn ? '#ff1744' : '#ffca28';
  }
}

function toggle(c) {
  selected = selected.includes(c) ? selected.filter(x => x !== c) : [...selected, c];
  renderHands();
  document.getElementById('playBtn').disabled = selected.length === 0 || myIndex !== currentTurn;
}

function playSelected() {
  if (selected.length === 0 || myIndex !== currentTurn) return;
  socket.emit('playCards', { roomId, cards: selected });
  selected = [];
  renderHands();
}

function skipTurn() {
  if (myIndex !== currentTurn) return;
  socket.emit('skipTurn', { roomId });
}

function updateTurn() {
  const myTurn = myIndex === currentTurn;
  document.getElementById('playBtn').disabled = !myTurn || selected.length === 0;
  document.getElementById('skipBtn').disabled = !myTurn;
  document.getElementById('status').innerHTML = myTurn
    ? '<span style="color:#ff1744;animation:blink 1s infinite;font-size:44px">ĐẾN LƯỢT BẠN – ĐÁNH ĐI!</span>'
    : `Đợi <strong>${players[currentTurn] || '???'} đánh...</strong>`;
}
</script>
